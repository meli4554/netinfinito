<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transfer√™ncias - NetInFi</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .transfers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .transfer-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s;
    }

    .transfer-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .transfer-card.pulsing-card {
      animation: cardPulse 3s ease-in-out infinite;
      border-color: var(--warning);
    }

    @keyframes cardPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
      }
      50% {
        box-shadow: 0 0 20px 5px rgba(255, 193, 7, 0.6);
      }
    }

    .transfer-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .transfer-number {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
    }

    .transfer-info {
      margin: 10px 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .transfer-info strong {
      color: var(--text);
    }

    .progress-container {
      margin: 15px 0;
      background: var(--background);
      border-radius: 8px;
      padding: 10px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 5px;
      color: var(--text-muted);
    }

    .progress-bar-track {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--success);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-bar-fill.pulsing {
      animation: pulse 2s ease-in-out infinite;
      background: var(--warning);
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.6;
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-20px);
      }
    }

    .items-list {
      margin: 15px 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .item-row:last-child {
      border-bottom: none;
    }

    .item-product {
      flex: 1;
    }

    .item-serial {
      font-size: 11px;
      color: var(--text-muted);
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
      z-index: 100;
    }

    .search-box input {
      padding-right: 40px;
      transition: all 0.3s;
    }

    .search-box input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .search-box input.has-value {
      border-color: var(--success);
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .product-search-results {
      border: 1px solid #444;
      border-radius: 6px;
      max-height: 280px;
      overflow-y: auto;
      background: #1a1a1a;
      position: absolute;
      width: 100%;
      z-index: 9999;
      display: none;
      margin-top: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      top: 100%;
      left: 0;
    }

    .product-search-results.active {
      display: block;
    }

    .search-result-category {
      padding: 10px 14px;
      background: #0d0d0d;
      font-size: 11px;
      color: #888;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .search-result-item {
      padding: 14px;
      cursor: pointer;
      border-bottom: 1px solid #2a2a2a;
      transition: all 0.2s ease;
      line-height: 1.6;
      background: #1a1a1a;
    }

    .search-result-item:hover {
      background: #2a2a2a;
      border-left: 3px solid var(--primary);
      padding-left: 11px;
    }

    .search-result-item:last-child {
      border-bottom: none;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }

    .search-result-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
      color: #fff;
    }

    .search-result-details {
      font-size: 12px;
      color: #888;
      display: block;
      font-family: 'Courier New', monospace;
    }

    .search-result-item:hover .search-result-details {
      color: #aaa;
    }

    .search-result-empty {
      padding: 30px;
      text-align: center;
      color: #666;
      font-size: 13px;
    }

    .search-result-empty-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .modal-large {
      max-width: 900px;
    }

    .items-table {
      margin-top: 15px;
    }

    .add-item-row {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      position: relative;
      transition: all 0.3s;
      z-index: 1;
    }

    .add-item-row:focus-within {
      z-index: 10;
    }

    .add-item-row:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .item-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .item-row-number {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
    }

    .item-row-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      position: relative;
    }

    .item-row-fields .full-width {
      grid-column: 1 / -1;
      margin-bottom: 10px;
    }

    .remove-item-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: var(--danger);
      color: white;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .remove-item-btn:hover {
      background: #c62828;
      transform: scale(1.1);
    }

    .detail-modal .item-detail {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 120px;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 10px;
      align-items: center;
    }

    .item-detail.used {
      background: #e8f5e9;
    }

    .item-detail.returned {
      background: #e3f2fd;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }

    .filter-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: -2px;
      transition: all 0.3s;
    }

    .filter-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .filter-tab:hover {
      color: var(--primary);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/pages/dashboard.html" class="logo">
          <div class="logo-icon">NI</div>
          <span>NetInFi</span>
        </a>
        <nav class="nav">
          <a href="/pages/dashboard.html" class="nav-link">Dashboard</a>
          <a href="/pages/products.html" class="nav-link">Produtos</a>
          <a href="/pages/technicians.html" class="nav-link">T√©cnicos</a>
          <a href="/pages/almoxarifados.html" class="nav-link">Almoxarifados</a>
          <a href="/pages/transfers.html" class="nav-link active">Transfer√™ncias</a>
          <a href="/pages/reports.html" class="nav-link">Relat√≥rios</a>
          <a href="#" onclick="AuthService.logout(); return false;" class="nav-link">Sair</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top: 30px;">
    <div class="card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="card-title">Transfer√™ncias</h2>
        <button class="btn btn-primary" onclick="showNewTransferModal()">+ Nova Transfer√™ncia</button>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all')">
          <span style="font-size: 16px; margin-right: 5px;">üìã</span> Todas
        </button>
        <button class="filter-tab" onclick="setFilter('warehouse')">
          <span style="font-size: 16px; margin-right: 5px;">üì¶</span> Sa√≠da do Estoque
        </button>
        <button class="filter-tab" onclick="setFilter('in_hands')">
          <span style="font-size: 16px; margin-right: 5px;">üöö</span> Em M√£os
        </button>
        <button class="filter-tab" onclick="setFilter('finished')">
          <span style="font-size: 16px; margin-right: 5px;">‚úÖ</span> Finalizado
        </button>
      </div>

      <div id="content">
        <div style="text-align: center; padding: 40px;">
          <div class="loading" style="margin: 0 auto;"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Nova Transfer√™ncia -->
  <div id="newTransferModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>Nova Transfer√™ncia</h3>
        <span class="close" onclick="hideNewTransferModal()">&times;</span>
      </div>
      <form id="newTransferForm">
        <div class="form-group">
          <label class="form-label">T√©cnico *</label>
          <select id="technicianId" class="form-control" required>
            <option value="">Selecione o t√©cnico...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Produtos * <small style="color: var(--text-muted); font-weight: 400;">(m√≠nimo 1 produto)</small></span>
            <span id="itemCounter" style="font-size: 12px; color: var(--text-muted); font-weight: 400;">0 produto(s) adicionado(s)</span>
          </label>

          <div style="background: var(--background); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px;">
            <div id="itemsList"></div>

            <div id="emptyItemsMessage" style="text-align: center; padding: 30px; color: var(--text-muted);">
              <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
              <p>Nenhum produto adicionado ainda</p>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="addItemRow()" style="width: 100%;">
            <span style="font-size: 18px; margin-right: 5px;">+</span> Adicionar Produto
          </button>
        </div>

        <div class="form-group">
          <label class="form-label">Observa√ß√µes</label>
          <textarea id="note" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre a transfer√™ncia..."></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideNewTransferModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="submitTransferBtn">Criar Transfer√™ncia</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalhes da Transfer√™ncia -->
  <div id="detailModal" class="modal">
    <div class="modal-content modal-large detail-modal">
      <div class="modal-header">
        <h3 id="detailTitle">Transfer√™ncia</h3>
        <span class="close" onclick="hideDetailModal()">&times;</span>
      </div>
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- Modal: Marcar Item como Usado -->
  <div id="useModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Marcar Item como Usado</h3>
        <span class="close" onclick="hideUseModal()">&times;</span>
      </div>
      <form id="useForm">
        <input type="hidden" id="useItemId">
        <div class="form-group">
          <label class="form-label">C√≥digo do Cliente IXC</label>
          <input type="text" id="ixcClientCode" class="form-control" placeholder="Ex: 12345">
        </div>
        <div class="form-group">
          <label class="form-label">Observa√ß√µes de Uso</label>
          <textarea id="usageNote" class="form-control" rows="3" placeholder="Detalhes da instala√ß√£o..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideUseModal()">Cancelar</button>
          <button type="submit" class="btn btn-success">Confirmar Uso</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    let transfers = [];
    let technicians = [];
    let products = [];
    let warehouses = [];
    let currentFilter = 'all';
    let itemCounter = 0;
    let currentTransferId = null;

    const STATUS_MAP = {
      PENDING: { label: 'üì¶ Sa√≠da do Estoque', color: 'secondary', icon: 'üì¶' },
      IN_HANDS: { label: 'üöö Em M√£os', color: 'warning', icon: 'üöö' },
      PARTIALLY_USED: { label: '‚ö° Em Uso', color: 'info', icon: '‚ö°' },
      USED: { label: '‚úÖ Finalizado', color: 'success', icon: '‚úÖ' },
      PARTIALLY_RETURNED: { label: '‚Ü©Ô∏è Devolvendo', color: 'info', icon: '‚Ü©Ô∏è' },
      RETURNED: { label: '‚úÖ Devolvido', color: 'primary', icon: '‚úÖ' },
      CANCELED: { label: '‚ùå Cancelado', color: 'danger', icon: '‚ùå' }
    };

    const ITEM_STATUS_MAP = {
      PENDING: { label: 'Pendente', color: 'secondary' },
      IN_HANDS: { label: 'Em M√£os', color: 'warning' },
      USED: { label: 'Usado', color: 'success' },
      RETURNED: { label: 'Devolvido', color: 'primary' }
    };

    async function init() {
      await AuthService.requireAuth();
      await loadData();
    }

    async function loadData() {
      try {
        const [transfersRes, techsRes, prodsRes] = await Promise.all([
          fetch('/transfers', { credentials: 'include' }),
          fetch('/technicians', { credentials: 'include' }),
          fetch('/products', { credentials: 'include' })
        ]);

        transfers = await transfersRes.json();
        technicians = await techsRes.json();
        products = await prodsRes.json();

        populateTechnicians();
        renderTransfers();
      } catch (e) {
        console.error(e);
        document.getElementById('content').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar dados</p>';
      }
    }

    function populateTechnicians() {
      const select = document.getElementById('technicianId');
      select.innerHTML = '<option value="">Selecione...</option>' +
        technicians.filter(t => t.isActive).map(t =>
          `<option value="${t.id}">${t.name}</option>`
        ).join('');
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      renderTransfers();
    }

    function filterTransfers() {
      if (currentFilter === 'all') return transfers;

      // Sa√≠da do Estoque - Aguardando sair do almoxarifado
      if (currentFilter === 'warehouse') {
        return transfers.filter(t => t.status === 'PENDING');
      }

      // Em M√£os - T√©cnico est√° com os produtos (pode estar usando parcialmente)
      if (currentFilter === 'in_hands') {
        return transfers.filter(t => ['IN_HANDS', 'PARTIALLY_USED', 'PARTIALLY_RETURNED'].includes(t.status));
      }

      // Finalizado - Processo conclu√≠do (todos itens usados ou devolvidos)
      if (currentFilter === 'finished') {
        return transfers.filter(t => ['USED', 'RETURNED'].includes(t.status));
      }

      return transfers.filter(t => t.status === currentFilter);
    }

    function renderTransfers() {
      const filtered = filterTransfers();
      const content = document.getElementById('content');

      if (!filtered.length) {
        content.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhuma transfer√™ncia encontrada</p>';
        return;
      }

      content.innerHTML = `<div class="transfers-grid">${filtered.map(renderTransferCard).join('')}</div>`;
    }

    function renderTransferCard(transfer) {
      const status = STATUS_MAP[transfer.status];
      const usedCount = transfer.items.filter(i => i.status === 'USED').length;
      const returnedCount = transfer.items.filter(i => i.status === 'RETURNED').length;
      const totalCount = transfer.items.length;
      const progressPercent = ((usedCount + returnedCount) / totalCount) * 100;
      const isPulsing = ['IN_HANDS', 'PARTIALLY_USED', 'PARTIALLY_RETURNED'].includes(transfer.status);

      // Calcular tempo em m√£os
      let timeInHands = '';
      if (transfer.transferredAt && ['IN_HANDS', 'PARTIALLY_USED', 'PARTIALLY_RETURNED'].includes(transfer.status)) {
        const now = new Date();
        const transferDate = new Date(transfer.transferredAt);
        const diffMs = now - transferDate;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);

        if (diffDays > 0) {
          timeInHands = `${diffDays} dia(s)`;
        } else if (diffHours > 0) {
          timeInHands = `${diffHours} hora(s)`;
        } else {
          timeInHands = 'Menos de 1 hora';
        }
      }

      return `
        <div class="transfer-card ${isPulsing ? 'pulsing-card' : ''}">
          <div class="transfer-header">
            <div class="transfer-number">${transfer.number}</div>
            <span class="badge badge-${status.color}">${status.label}</span>
          </div>

          <div class="transfer-info">
            <strong>T√©cnico:</strong> ${transfer.technician.name}
          </div>

          <div class="transfer-info">
            <strong>Criado em:</strong> ${new Date(transfer.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
          </div>

          ${transfer.transferredAt ? `
            <div class="transfer-info">
              <strong>Sa√≠da:</strong> ${new Date(transfer.transferredAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
            </div>
          ` : ''}

          ${timeInHands ? `
            <div class="transfer-info" style="background: var(--warning); color: white; padding: 8px; border-radius: 4px; margin: 10px 0; text-align: center; font-weight: 600;">
              ‚è±Ô∏è Em m√£os h√° ${timeInHands}
            </div>
          ` : ''}

          <div class="progress-container">
            <div class="progress-label">
              <span>${isPulsing ? '‚ö° Progresso' : 'Progresso'}</span>
              <span><strong>${usedCount + returnedCount}</strong> de <strong>${totalCount}</strong> item(ns)</span>
            </div>
            <div class="progress-bar-track">
              <div class="progress-bar-fill ${isPulsing ? 'pulsing' : ''}" style="width: ${progressPercent}%"></div>
            </div>
          </div>

          <div class="items-list">
            ${transfer.items.slice(0, 3).map(item => {
              const itemStatus = ITEM_STATUS_MAP[item.status];
              return `
                <div class="item-row">
                  <div class="item-product">
                    <div><strong>${item.product.name}</strong></div>
                    ${item.serialNumber ? `<div class="item-serial">SN: ${item.serialNumber}</div>` : ''}
                    ${item.macAddress ? `<div class="item-serial">MAC: ${item.macAddress}</div>` : ''}
                  </div>
                  <span class="badge badge-${itemStatus.color}" style="font-size: 11px;">${itemStatus.label}</span>
                </div>
              `;
            }).join('')}
            ${transfer.items.length > 3 ? `<div style="text-align: center; color: var(--text-muted); font-size: 12px; margin-top: 8px;">+${transfer.items.length - 3} item(ns)</div>` : ''}
          </div>

          <div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-sm btn-primary" onclick="viewTransfer(${transfer.id})">Ver Detalhes</button>
            ${transfer.status === 'PENDING' ? `
              <button class="btn btn-sm btn-success" onclick="markAsTransferred(${transfer.id})">
                üöö Saiu do Estoque
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    function showNewTransferModal() {
      document.getElementById('newTransferForm').reset();
      document.getElementById('itemsList').innerHTML = '';
      itemCounter = 0;
      document.getElementById('emptyItemsMessage').style.display = 'block';
      updateItemCounter();
      document.getElementById('newTransferModal').style.display = 'block';
    }

    function hideNewTransferModal() {
      document.getElementById('newTransferModal').style.display = 'none';
    }

    function addItemRow() {
      itemCounter++;
      const div = document.createElement('div');
      div.id = `itemRow${itemCounter}`;
      div.className = 'add-item-row';
      div.innerHTML = `
        <div class="item-row-header">
          <span class="item-row-number">Produto #${itemCounter}</span>
          <button type="button" class="remove-item-btn" onclick="removeItemRow(${itemCounter})" title="Remover produto">√ó</button>
        </div>

        <div class="item-row-fields">
          <div class="search-box full-width">
            <input type="text" class="form-control product-search" placeholder="üîç Buscar por Serial Number, MAC ou nome do produto..." onkeyup="searchProduct(${itemCounter}, this.value)" onfocus="this.select()">
            <div id="searchResults${itemCounter}" class="product-search-results"></div>
            <input type="hidden" class="product-id" required>
            <input type="hidden" class="instance-id">
            <div class="selected-product-display" id="selectedProduct${itemCounter}" style="display: none; margin-top: 8px; padding: 8px; background: var(--background); border-radius: 4px; font-size: 13px; position: relative; padding-right: 35px;">
              <button type="button" onclick="clearProductSelection(${itemCounter})" style="position: absolute; top: 4px; right: 4px; background: var(--danger); border: none; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;" title="Limpar sele√ß√£o">√ó</button>
            </div>
          </div>

          <div>
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Serial Number</label>
            <input type="text" class="form-control serial-number" placeholder="Opcional">
          </div>

          <div>
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">MAC Address</label>
            <input type="text" class="form-control mac-address" placeholder="Opcional">
          </div>

          <div class="full-width">
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Quantidade *</label>
            <input type="number" class="form-control quantity" placeholder="Ex: 1" min="0.01" step="0.01" value="1" required>
          </div>
        </div>
      `;
      document.getElementById('itemsList').appendChild(div);
      document.getElementById('emptyItemsMessage').style.display = 'none';
      updateItemCounter();
    }

    function removeItemRow(id) {
      const row = document.getElementById(`itemRow${id}`);
      row.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        row.remove();
        updateItemCounter();

        // Show empty message if no items
        const itemsList = document.getElementById('itemsList');
        if (itemsList.children.length === 0) {
          document.getElementById('emptyItemsMessage').style.display = 'block';
        }
      }, 300);
    }

    function updateItemCounter() {
      const count = document.getElementById('itemsList').children.length;
      document.getElementById('itemCounter').textContent = `${count} produto(s) adicionado(s)`;

      // Enable/disable submit button based on items
      const submitBtn = document.getElementById('submitTransferBtn');
      if (count === 0) {
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
      } else {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
      }
    }

    let searchTimeout;
    async function searchProduct(rowId, query) {
      clearTimeout(searchTimeout);
      const resultsDiv = document.getElementById(`searchResults${rowId}`);

      if (query.length < 2) {
        resultsDiv.classList.remove('active');
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          // Search by serial/MAC
          const res = await fetch(`/transfers/search-product?q=${encodeURIComponent(query)}`, { credentials: 'include' });
          const instances = await res.json();

          // Also search products by name
          const matchingProds = products.filter(p =>
            p.name.toLowerCase().includes(query.toLowerCase()) ||
            p.sku.toLowerCase().includes(query.toLowerCase())
          );

          resultsDiv.innerHTML = '';

          // Show product instances first (with serial/MAC)
          if (instances.length > 0) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'search-result-category';
            categoryDiv.innerHTML = 'üì¶ Produtos com Serial/MAC';
            resultsDiv.appendChild(categoryDiv);

            instances.forEach(inst => {
              const div = document.createElement('div');
              div.className = 'search-result-item';
              div.innerHTML = `
                <span class="search-result-title">${inst.product.name}</span>
                <span class="search-result-details">
                  ${inst.serialNumber ? `SN: ${inst.serialNumber}` : 'Sem SN'}
                  ${inst.macAddress ? ` ‚Ä¢ MAC: ${inst.macAddress}` : ''}
                </span>
              `;
              div.onclick = () => selectProductInstance(rowId, inst);
              resultsDiv.appendChild(div);
            });
          }

          // Show matching products (without specific serial/MAC)
          if (matchingProds.length > 0) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'search-result-category';
            categoryDiv.innerHTML = 'üìã Produtos Gerais';
            resultsDiv.appendChild(categoryDiv);

            matchingProds.slice(0, 5).forEach(prod => {
              const div = document.createElement('div');
              div.className = 'search-result-item';
              div.innerHTML = `
                <span class="search-result-title">${prod.name}</span>
                <span class="search-result-details">SKU: ${prod.sku} ‚Ä¢ Sem rastreamento</span>
              `;
              div.onclick = () => selectProduct(rowId, prod);
              resultsDiv.appendChild(div);
            });
          }

          if (instances.length === 0 && matchingProds.length === 0) {
            resultsDiv.innerHTML = `
              <div class="search-result-empty">
                <div class="search-result-empty-icon">üîç</div>
                <div>Nenhum resultado encontrado</div>
                <div style="font-size: 11px; margin-top: 5px; color: #555;">Tente buscar por nome, SKU, SN ou MAC</div>
              </div>
            `;
          }

          resultsDiv.classList.add('active');
        } catch (e) {
          console.error(e);
          resultsDiv.innerHTML = `
            <div class="search-result-empty">
              <div class="search-result-empty-icon">‚ùå</div>
              <div style="color: var(--danger);">Erro ao buscar produtos</div>
              <div style="font-size: 11px; margin-top: 5px; color: #555;">Tente novamente</div>
            </div>
          `;
          resultsDiv.classList.add('active');
        }
      }, 300);
    }

    function selectProductInstance(rowId, instance) {
      const row = document.getElementById(`itemRow${rowId}`);
      const searchInput = row.querySelector('.product-search');
      searchInput.value = '';
      searchInput.classList.add('has-value');
      row.querySelector('.product-id').value = instance.productId;
      row.querySelector('.instance-id').value = instance.id;
      row.querySelector('.serial-number').value = instance.serialNumber || '';
      row.querySelector('.mac-address').value = instance.macAddress || '';

      // Show selected product
      const display = document.getElementById(`selectedProduct${rowId}`);
      display.innerHTML = `
        <strong style="color: var(--success);">‚úì ${instance.product.name}</strong><br>
        <small>SN: ${instance.serialNumber || 'N/A'} | MAC: ${instance.macAddress || 'N/A'}</small>
        <button type="button" onclick="clearProductSelection(${rowId})" style="position: absolute; top: 4px; right: 4px; background: var(--danger); border: none; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;" title="Limpar sele√ß√£o">√ó</button>
      `;
      display.style.display = 'block';

      document.getElementById(`searchResults${rowId}`).classList.remove('active');
    }

    function selectProduct(rowId, product) {
      const row = document.getElementById(`itemRow${rowId}`);
      const searchInput = row.querySelector('.product-search');
      searchInput.value = '';
      searchInput.classList.add('has-value');
      row.querySelector('.product-id').value = product.id;
      row.querySelector('.instance-id').value = '';

      // Show selected product
      const display = document.getElementById(`selectedProduct${rowId}`);
      display.innerHTML = `
        <strong style="color: var(--success);">‚úì ${product.name}</strong><br>
        <small>SKU: ${product.sku}</small>
        <button type="button" onclick="clearProductSelection(${rowId})" style="position: absolute; top: 4px; right: 4px; background: var(--danger); border: none; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;" title="Limpar sele√ß√£o">√ó</button>
      `;
      display.style.display = 'block';

      document.getElementById(`searchResults${rowId}`).classList.remove('active');
    }

    function clearProductSelection(rowId) {
      const row = document.getElementById(`itemRow${rowId}`);
      const searchInput = row.querySelector('.product-search');
      searchInput.value = '';
      searchInput.classList.remove('has-value');
      row.querySelector('.product-id').value = '';
      row.querySelector('.instance-id').value = '';
      row.querySelector('.serial-number').value = '';
      row.querySelector('.mac-address').value = '';

      document.getElementById(`selectedProduct${rowId}`).style.display = 'none';
      searchInput.focus();
    }

    document.getElementById('newTransferForm').onsubmit = async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitTransferBtn');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading" style="width: 16px; height: 16px; border-width: 2px;"></span> Criando...';

      try {
        const techId = parseInt(document.getElementById('technicianId').value);

        if (!techId) {
          showAlert('Selecione um t√©cnico', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        const tech = technicians.find(t => t.id === techId);

        if (!tech) {
          showAlert('T√©cnico n√£o encontrado', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        if (!tech.warehouse) {
          showAlert('T√©cnico n√£o possui almoxarifado associado. Configure o almoxarifado do t√©cnico antes de criar transfer√™ncias.', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        const rows = document.querySelectorAll('[id^="itemRow"]');
        const items = [];

        rows.forEach(row => {
          const productId = parseInt(row.querySelector('.product-id').value);
          const instanceId = row.querySelector('.instance-id').value;
          const serialNumber = row.querySelector('.serial-number').value;
          const macAddress = row.querySelector('.mac-address').value;
          const quantity = parseFloat(row.querySelector('.quantity').value);

          if (productId && quantity > 0) {
            items.push({
              productId,
              productInstanceId: instanceId ? parseInt(instanceId) : undefined,
              serialNumber: serialNumber || undefined,
              macAddress: macAddress || undefined,
              quantity
            });
          }
        });

        if (items.length === 0) {
          showAlert('Adicione pelo menos um produto', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        const payload = {
          fromWarehouseId: 1, // Almoxarifado principal
          toWarehouseId: tech.warehouse.id,
          technicianId: techId,
          items,
          note: document.getElementById('note').value || undefined
        };

        console.log('Enviando transfer√™ncia:', payload);

        const res = await fetch('/transfers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          showAlert('Transfer√™ncia criada com sucesso!', 'success');
          hideNewTransferModal();
          loadData();
        } else {
          let errorMessage = 'Erro ao criar transfer√™ncia';
          try {
            const error = await res.json();
            errorMessage = error.message || error.error || errorMessage;
            console.error('Erro do servidor:', error);
          } catch (e) {
            const errorText = await res.text();
            console.error('Resposta do servidor:', errorText);
            errorMessage = `Erro do servidor (${res.status}): ${errorText.substring(0, 100)}`;
          }
          showAlert(errorMessage, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (e) {
        console.error('Erro ao criar transfer√™ncia:', e);
        showAlert(`Erro: ${e.message}`, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    };

    async function markAsTransferred(id) {
      if (!confirm('Confirmar que a transfer√™ncia saiu do almoxarifado?')) return;

      try {
        const res = await fetch(`/transfers/${id}/transfer`, {
          method: 'PATCH',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Transfer√™ncia marcada como em m√£os do t√©cnico!', 'success');
          loadData();
        } else {
          showAlert('Erro ao atualizar transfer√™ncia', 'error');
        }
      } catch (e) {
        console.error(e);
        showAlert('Erro ao atualizar transfer√™ncia', 'error');
      }
    }

    async function viewTransfer(id) {
      currentTransferId = id;
      const transfer = transfers.find(t => t.id === id);
      if (!transfer) return;

      const status = STATUS_MAP[transfer.status];

      document.getElementById('detailTitle').textContent = `Transfer√™ncia ${transfer.number}`;
      document.getElementById('detailContent').innerHTML = `
        <div style="margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>T√©cnico:</strong> ${transfer.technician.name}<br>
              <strong>Status:</strong> <span class="badge badge-${status.color}">${status.label}</span><br>
              <strong>Criado em:</strong> ${new Date(transfer.createdAt).toLocaleString('pt-BR')}
            </div>
            <div>
              ${transfer.transferredAt ? `<strong>Transferido em:</strong> ${new Date(transfer.transferredAt).toLocaleString('pt-BR')}<br>` : ''}
              ${transfer.receivedAt ? `<strong>Recebido em:</strong> ${new Date(transfer.receivedAt).toLocaleString('pt-BR')}<br>` : ''}
              ${transfer.note ? `<strong>Obs:</strong> ${transfer.note}` : ''}
            </div>
          </div>
        </div>

        <h4 style="margin: 20px 0 10px 0;">Itens da Transfer√™ncia</h4>
        <div>
          ${transfer.items.map(item => {
            const itemStatus = ITEM_STATUS_MAP[item.status];
            return `
              <div class="item-detail ${item.status === 'USED' ? 'used' : item.status === 'RETURNED' ? 'returned' : ''}">
                <div>
                  <strong>${item.product.name}</strong><br>
                  ${item.serialNumber ? `<small>SN: ${item.serialNumber}</small><br>` : ''}
                  ${item.macAddress ? `<small>MAC: ${item.macAddress}</small><br>` : ''}
                  ${item.invoiceNumber ? `<small>NF: ${item.invoiceNumber}</small><br>` : ''}
                  ${item.ixcClientCode ? `<small>Cliente IXC: ${item.ixcClientCode}</small><br>` : ''}
                  ${item.usageNote ? `<small style="color: var(--text-muted);">${item.usageNote}</small>` : ''}
                </div>
                <div>
                  Qtd: <strong>${item.quantity}</strong>
                </div>
                <div>
                  <span class="badge badge-${itemStatus.color}">${itemStatus.label}</span>
                  ${item.usedAt ? `<br><small>${new Date(item.usedAt).toLocaleDateString('pt-BR')}</small>` : ''}
                  ${item.returnedAt ? `<br><small>${new Date(item.returnedAt).toLocaleDateString('pt-BR')}</small>` : ''}
                </div>
                <div>
                  ${item.status === 'IN_HANDS' ? `
                    <button class="btn btn-sm btn-success" onclick="showUseModal(${item.id})">Marcar Usado</button>
                    <button class="btn btn-sm btn-primary" onclick="markItemReturned(${transfer.id}, ${item.id})" style="margin-top: 5px;">Devolver</button>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      document.getElementById('detailModal').style.display = 'block';
    }

    function hideDetailModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    function showUseModal(itemId) {
      document.getElementById('useItemId').value = itemId;
      document.getElementById('useForm').reset();
      document.getElementById('useItemId').value = itemId;
      document.getElementById('useModal').style.display = 'block';
    }

    function hideUseModal() {
      document.getElementById('useModal').style.display = 'none';
    }

    document.getElementById('useForm').onsubmit = async (e) => {
      e.preventDefault();

      const itemId = parseInt(document.getElementById('useItemId').value);
      const ixcClientCode = document.getElementById('ixcClientCode').value;
      const usageNote = document.getElementById('usageNote').value;

      try {
        const res = await fetch(`/transfers/${currentTransferId}/items/${itemId}/use`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ixcClientCode, usageNote })
        });

        if (res.ok) {
          showAlert('Item marcado como usado!', 'success');
          hideUseModal();
          loadData();
          setTimeout(() => viewTransfer(currentTransferId), 500);
        } else {
          showAlert('Erro ao marcar item', 'error');
        }
      } catch (e) {
        console.error(e);
        showAlert('Erro ao marcar item', 'error');
      }
    };

    async function markItemReturned(transferId, itemId) {
      if (!confirm('Confirmar devolu√ß√£o deste item?')) return;

      try {
        const res = await fetch(`/transfers/${transferId}/items/${itemId}/return`, {
          method: 'PATCH',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Item devolvido!', 'success');
          loadData();
          setTimeout(() => viewTransfer(transferId), 500);
        } else {
          showAlert('Erro ao devolver item', 'error');
        }
      } catch (e) {
        console.error(e);
        showAlert('Erro ao devolver item', 'error');
      }
    }

    window.onclick = (e) => {
      if (e.target.id === 'newTransferModal') hideNewTransferModal();
      if (e.target.id === 'detailModal') hideDetailModal();
      if (e.target.id === 'useModal') hideUseModal();
    };

    init();
  </script>
</body>
</html>
