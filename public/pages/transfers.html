<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sa√≠da - RCONTROL</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* Container */
    .main-container {
      max-width: 1400px;
      margin: 24px auto;
      padding: 0 20px;
    }

    /* Grid de Cards */
    .transfers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    /* Transfer Card */
    .transfer-card {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .transfer-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    /* Header do Card */
    .card-header-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .transfer-number {
      font-size: 14px;
      font-weight: 700;
      color: #3b82f6;
    }

    /* Info Box */
    .info-box {
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-box-icon {
      width: 26px;
      height: 26px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
    }

    .info-label {
      font-size: 9px;
      color: #64748b;
      margin-bottom: 2px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .info-value {
      font-size: 12px;
      color: #e2e8f0;
      font-weight: 600;
    }

    /* Timer */
    .timer-box {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #1e293b;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-weight: 700;
      margin: 8px 0;
      position: relative;
      overflow: hidden;
    }

    .timer-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .timer-clock {
      display: inline-block;
      animation: clockPulse 2s ease-in-out infinite;
      margin-right: 6px;
    }

    @keyframes clockPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    /* Progress */
    .progress-container {
      margin: 8px 0;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 6px;
      padding: 8px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 6px;
      color: #94a3b8;
      font-weight: 600;
    }

    .progress-bar {
      height: 8px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 10px;
      transition: width 0.5s;
    }

    /* Items List */
    .items-compact {
      margin: 8px 0;
      max-height: 160px;
      overflow-y: auto;
    }

    .item-compact {
      padding: 8px;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 5px;
      border-left: 3px solid #3b82f6;
      margin-bottom: 6px;
    }

    .item-compact.used { border-left-color: #10b981; }
    .item-compact.in-hands { border-left-color: #fbbf24; }

    .item-name {
      font-size: 12px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 3px;
    }

    .item-meta {
      font-size: 10px;
      color: #64748b;
      font-family: monospace;
    }

    /* Buttons Leves e Modernos */
    .btn-group {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .btn-compact {
      flex: 1;
      padding: 9px 12px;
      border: none;
      border-radius: 7px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .btn-compact svg {
      flex-shrink: 0;
    }

    .btn-primary-grad {
      background: #3b82f6;
      color: white;
    }

    .btn-success-grad {
      background: #10b981;
      color: white;
    }

    .btn-info-grad {
      background: #06b6d4;
      color: white;
    }

    .btn-warning-grad {
      background: #f59e0b;
      color: white;
    }

    .btn-danger-grad {
      background: #ef4444;
      color: white;
    }

    .btn-compact:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-compact:active {
      transform: translateY(0);
      opacity: 1;
    }

    /* Bot√µes de a√ß√£o nos itens */
    .item-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .btn-item {
      flex: 1;
      padding: 9px 12px;
      border: none;
      border-radius: 7px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .btn-item svg {
      flex-shrink: 0;
    }

    .btn-item:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-item:active {
      transform: translateY(0);
      opacity: 1;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 8px 14px;
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 7px;
      cursor: pointer;
      color: #94a3b8;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .filter-tab:hover {
      background: rgba(30, 41, 59, 0.5);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .filter-tab.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .filter-count {
      background: rgba(255, 255, 255, 0.25);
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      margin-left: 5px;
    }

    /* Modal */
    .modal-compact {
      max-width: 700px;
      width: 90%;
    }

    .modal-body {
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .form-group-compact {
      margin-bottom: 16px;
    }

    .form-label-compact {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-control-compact {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-control-compact:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Search Results */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 250px;
      overflow-y: auto;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 6px;
      margin-top: 4px;
      z-index: 1000;
      display: none;
    }

    .search-results.active { display: block; }

    .search-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #2a2a2a;
      transition: all 0.2s;
    }

    .search-item:hover {
      background: #2a2a2a;
      border-left: 3px solid var(--primary);
    }

    .search-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .search-meta {
      font-size: 12px;
      color: #888;
    }

    /* Item Row */
    .item-row {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      position: relative;
    }

    .item-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .remove-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
    }

    .selected-product {
      padding: 10px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 6px;
      margin-top: 8px;
      font-size: 13px;
      position: relative;
    }

    /* Modal Footer */
    .modal-footer-compact {
      display: flex;
      gap: 10px;
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
    }

    .modal-footer-compact .btn {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    /* Detail Modal */
    .detail-section {
      background: rgba(15, 23, 42, 0.4);
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
      margin-bottom: 16px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .detail-item-label {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .detail-item-value {
      font-size: 14px;
      color: #e2e8f0;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/pages/dashboard.html" class="logo">
          <div class="logo-icon">R</div>
          <span>CONTROL</span>
        </a>

        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <nav class="nav" id="navMenu">
          <a href="/pages/dashboard.html" class="nav-link">Dashboard</a>
          <a href="/pages/products.html" class="nav-link">Produtos</a>
          <a href="/pages/technicians.html" class="nav-link">T√©cnicos</a>
          <a href="/pages/almoxarifados.html" class="nav-link">Almoxarifados</a>
          <a href="/pages/transfers.html" class="nav-link active">Sa√≠da</a>
          <a href="/pages/contabilizacao.html" class="nav-link">Contabiliza√ß√£o</a>
          <a href="#" onclick="AuthService.logout(); return false;" class="nav-link">Sair</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="main-container">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #06b6d4, #0284c7); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);">
            <svg style="width: 26px; height: 26px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
          </div>
          <div>
            <h2 style="font-size: 24px; font-weight: 700; margin: 0; color: #e2e8f0; line-height: 1.2;">
              Sa√≠da de Produtos
            </h2>
            <p style="color: #64748b; font-size: 13px; margin: 4px 0 0 0; font-weight: 500;">Gerencie as sa√≠das para t√©cnicos</p>
          </div>
        </div>
        <button class="btn btn-primary" onclick="showNewTransferModal()" style="background: #10b981; border-radius: 8px; padding: 11px 20px; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
          <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          Nova Sa√≠da
        </button>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter(event, 'all')">
          Todas <span class="filter-count" id="count-all">0</span>
        </button>
        <button class="filter-tab" onclick="setFilter(event, 'warehouse')">
          Sa√≠da do Estoque <span class="filter-count" id="count-warehouse">0</span>
        </button>
        <button class="filter-tab" onclick="setFilter(event, 'in_hands')">
          Em M√£os <span class="filter-count" id="count-in_hands">0</span>
        </button>
        <button class="filter-tab" onclick="setFilter(event, 'finished')">
          Finalizado <span class="filter-count" id="count-finished">0</span>
        </button>
        <button class="filter-tab" onclick="setFilter(event, 'canceled')">
          Cancelados <span class="filter-count" id="count-canceled">0</span>
        </button>
      </div>

      <!-- Filtro de Data (s√≥ vis√≠vel em Cancelados) -->
      <div id="dateFilter" style="display: none; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <label style="font-weight: 600; color: #10b981;">Filtrar por Data:</label>
          </div>
          <input type="date" id="dateFrom" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px;" onchange="renderTransfers()">
          <span style="color: #64748b;">at√©</span>
          <input type="date" id="dateTo" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px;" onchange="renderTransfers()">
          <button onclick="clearDateFilter()" style="padding: 8px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 6px; color: #ef4444; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
            Limpar
          </button>
        </div>
      </div>

      <div id="content">
        <div style="text-align: center; padding: 40px;">
          <div class="loading"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Nova Transfer√™ncia -->
  <div id="newTransferModal" class="modal">
    <div class="modal-content modal-compact">
      <div class="modal-header">
        <h3>Nova Transfer√™ncia</h3>
        <span class="close" onclick="hideModal('newTransferModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="newTransferForm">
          <div class="form-group-compact">
            <label class="form-label-compact">T√©cnico *</label>
            <select id="technicianId" class="form-control-compact" required>
              <option value="">Selecione...</option>
            </select>
          </div>

          <div class="form-group-compact">
            <label class="form-label-compact">
              Produtos * <small style="color: #64748b;">(m√≠nimo 1)</small>
              <span id="itemCounter" style="float: right; font-size: 12px; color: #64748b; font-weight: 400;">0 produto(s)</span>
            </label>
            <div id="itemsList"></div>
            <button type="button" class="btn btn-secondary" onclick="addItemRow()" style="width: 100%; margin-top: 10px;">
              + Adicionar Produto
            </button>
          </div>

          <div class="form-group-compact">
            <label class="form-label-compact">Observa√ß√µes</label>
            <textarea id="note" class="form-control-compact" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer-compact">
        <button type="button" class="btn btn-secondary" onclick="hideModal('newTransferModal')">Cancelar</button>
        <button type="submit" class="btn btn-primary" onclick="submitTransfer()">Criar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Detalhes -->
  <div id="detailModal" class="modal">
    <div class="modal-content modal-compact">
      <div class="modal-header">
        <h3 id="detailTitle">Transfer√™ncia</h3>
        <span class="close" onclick="hideModal('detailModal')">&times;</span>
      </div>
      <div class="modal-body" id="detailContent"></div>
    </div>
  </div>

  <!-- Modal: Marcar Usado -->
  <div id="useModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Marcar como Usado</h3>
        <span class="close" onclick="hideModal('useModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="useForm">
          <input type="hidden" id="useItemId">
          <div class="form-group-compact">
            <label class="form-label-compact">C√≥digo Cliente IXC</label>
            <input type="text" id="ixcClientCode" class="form-control-compact" placeholder="Ex: 12345">
          </div>
          <div class="form-group-compact">
            <label class="form-label-compact">Observa√ß√µes</label>
            <textarea id="usageNote" class="form-control-compact" rows="2" placeholder="Detalhes..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer-compact">
        <button class="btn btn-secondary" onclick="hideModal('useModal')">Cancelar</button>
        <button class="btn btn-success" onclick="submitUse()">Confirmar</button>
      </div>
    </div>
  </div>

  <script src="/js/menu.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let transfers = [];
    let technicians = [];
    let products = [];
    let currentFilter = 'all';
    let itemCounter = 0;
    let currentTransferId = null;

    const STATUS_MAP = {
      PENDING: { label: 'üì¶ Sa√≠da do Estoque', color: 'secondary' },
      IN_HANDS: { label: 'üöö Em M√£os', color: 'warning' },
      PARTIALLY_USED: { label: '‚ö° Em Uso', color: 'info' },
      USED: { label: '‚úÖ Finalizado', color: 'success' },
      PARTIALLY_RETURNED: { label: '‚Ü©Ô∏è Devolvendo', color: 'info' },
      RETURNED: { label: '‚úÖ Devolvido', color: 'primary' },
      CANCELED: { label: '‚ùå Cancelado', color: 'danger' }
    };

    const ITEM_STATUS_MAP = {
      PENDING: { label: 'Pendente', color: 'secondary' },
      IN_HANDS: { label: 'Em M√£os', color: 'warning' },
      USED: { label: 'Usado', color: 'success' },
      RETURNED: { label: 'Devolvido', color: 'primary' }
    };

    async function init() {
      await AuthService.requireAuth();
      await loadData();
    }

    async function loadData() {
      try {
        const [transfersRes, techsRes, prodsRes] = await Promise.all([
          fetch('/transfers', { credentials: 'include' }),
          fetch('/technicians', { credentials: 'include' }),
          fetch('/products', { credentials: 'include' })
        ]);

        transfers = await transfersRes.json();
        technicians = await techsRes.json();
        products = await prodsRes.json();

        populateTechnicians();
        renderTransfers();
        updateFilterCounts();
      } catch (e) {
        console.error(e);
        document.getElementById('content').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar dados</p>';
      }
    }

    function populateTechnicians() {
      const select = document.getElementById('technicianId');
      select.innerHTML = '<option value="">Selecione...</option>' +
        technicians.filter(t => t.isActive).map(t =>
          `<option value="${t.id}">${t.name}</option>`
        ).join('');
    }

    function setFilter(event, filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      event.currentTarget.classList.add('active');
      renderTransfers();
    }

    function updateFilterCounts() {
      const activeTransfers = transfers.filter(t => t.status !== 'CANCELED');
      document.getElementById('count-all').textContent = activeTransfers.length;
      document.getElementById('count-warehouse').textContent = transfers.filter(t => t.status === 'PENDING').length;
      document.getElementById('count-in_hands').textContent = transfers.filter(t => ['IN_HANDS', 'PARTIALLY_USED', 'PARTIALLY_RETURNED'].includes(t.status)).length;
      document.getElementById('count-finished').textContent = transfers.filter(t => ['USED', 'RETURNED'].includes(t.status)).length;
      document.getElementById('count-canceled').textContent = transfers.filter(t => t.status === 'CANCELED').length;
    }

    function filterTransfers() {
      let filtered = [];

      if (currentFilter === 'all') filtered = transfers.filter(t => t.status !== 'CANCELED');
      else if (currentFilter === 'warehouse') filtered = transfers.filter(t => t.status === 'PENDING');
      else if (currentFilter === 'in_hands') filtered = transfers.filter(t => ['IN_HANDS', 'PARTIALLY_USED', 'PARTIALLY_RETURNED'].includes(t.status));
      else if (currentFilter === 'finished') filtered = transfers.filter(t => ['USED', 'RETURNED'].includes(t.status));
      else if (currentFilter === 'canceled') {
        filtered = transfers.filter(t => t.status === 'CANCELED');

        // Aplicar filtro de data se estiver preenchido
        const dateFrom = document.getElementById('dateFrom')?.value;
        const dateTo = document.getElementById('dateTo')?.value;

        if (dateFrom || dateTo) {
          filtered = filtered.filter(t => {
            const canceledDate = new Date(t.canceledAt || t.updatedAt);
            const from = dateFrom ? new Date(dateFrom + 'T00:00:00') : null;
            const to = dateTo ? new Date(dateTo + 'T23:59:59') : null;

            if (from && canceledDate < from) return false;
            if (to && canceledDate > to) return false;
            return true;
          });
        }
      }
      else filtered = transfers;

      return filtered;
    }

    function renderTransfers() {
      const filtered = filterTransfers();
      const content = document.getElementById('content');

      // Mostrar/ocultar filtro de data
      const dateFilter = document.getElementById('dateFilter');
      if (currentFilter === 'canceled') {
        dateFilter.style.display = 'block';
      } else {
        dateFilter.style.display = 'none';
      }

      if (!filtered.length) {
        content.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Nenhuma transfer√™ncia encontrada</p>';
        return;
      }

      // Renderizar lista para cancelados, cards para os outros
      if (currentFilter === 'canceled') {
        content.innerHTML = renderCanceledList(filtered);
      } else {
        content.innerHTML = `<div class="transfers-grid">${filtered.map(renderCard).join('')}</div>`;
        setTimeout(updateTimers, 0);
      }
    }

    function clearDateFilter() {
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      renderTransfers();
    }

    function renderCanceledList(canceledTransfers) {
      // Ordenar por data de cancelamento (mais recente primeiro)
      const sorted = canceledTransfers.sort((a, b) => {
        const dateA = new Date(a.canceledAt || a.updatedAt);
        const dateB = new Date(b.canceledAt || b.updatedAt);
        return dateB - dateA;
      });

      return `
        <div style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
          <!-- Cabe√ßalho da Tabela -->
          <div style="display: grid; grid-template-columns: 140px 1fr 200px 180px 180px; gap: 12px; padding: 12px 16px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 700; font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">
            <div>C√≥digo</div>
            <div>T√©cnico</div>
            <div>Criado Em</div>
            <div>Cancelado Em</div>
            <div style="text-align: center;">A√ß√µes</div>
          </div>

          <!-- Linhas da Tabela -->
          ${sorted.map(t => {
            const canceledDate = new Date(t.canceledAt || t.updatedAt);
            const createdDate = new Date(t.createdAt);

            return `
              <div style="display: grid; grid-template-columns: 140px 1fr 200px 180px 180px; gap: 12px; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; background: rgba(0,0,0,0.1);" onmouseover="this.style.background='rgba(0,0,0,0.25)'" onmouseout="this.style.background='rgba(0,0,0,0.1)'">
                <!-- C√≥digo -->
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 12px; color: #ef4444;">
                    ${t.number}
                  </div>
                </div>

                <!-- T√©cnico -->
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="background: rgba(236, 72, 153, 0.2); padding: 6px; border-radius: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </svg>
                  </div>
                  <div>
                    <div style="font-size: 13px; font-weight: 600; color: #e2e8f0;">${t.technician.name}</div>
                    <div style="font-size: 11px; color: #64748b;">${t.items.length} ${t.items.length === 1 ? 'item' : 'itens'}</div>
                  </div>
                </div>

                <!-- Criado Em -->
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="background: rgba(6, 182, 212, 0.2); padding: 6px; border-radius: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                  </div>
                  <div>
                    <div style="font-size: 12px; font-weight: 600; color: #e2e8f0;">${createdDate.toLocaleDateString('pt-BR')}</div>
                    <div style="font-size: 11px; color: #64748b;">${createdDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
                  </div>
                </div>

                <!-- Cancelado Em -->
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="background: rgba(239, 68, 68, 0.2); padding: 6px; border-radius: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                  </div>
                  <div>
                    <div style="font-size: 12px; font-weight: 600; color: #ef4444;">${canceledDate.toLocaleDateString('pt-BR')}</div>
                    <div style="font-size: 11px; color: #64748b;">${canceledDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
                  </div>
                </div>

                <!-- A√ß√µes -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 8px;">
                  <button onclick="viewTransfer(${t.id})" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 6px; color: #3b82f6; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                    Ver
                  </button>
                  <button onclick="deleteTransfer(${t.id}, '${t.number}')" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 6px; color: #ef4444; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Apagar
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderCard(t) {
      const status = STATUS_MAP[t.status];
      const total = t.items.length;
      const inHands = t.items.filter(i => i.status === 'IN_HANDS').length;
      const used = t.items.filter(i => i.status === 'USED').length;
      const returned = t.items.filter(i => i.status === 'RETURNED').length;
      const progress = ((inHands * 50 + (used + returned) * 100) / total);
      const showTimer = ['IN_HANDS', 'PARTIALLY_USED', 'PARTIALLY_RETURNED'].includes(t.status);

      return `
        <div class="transfer-card">
          <div class="card-header-flex">
            <span class="transfer-number">${t.number}</span>
            <span class="badge badge-${status.color}">${status.label}</span>
          </div>

          <div class="info-box">
            <div class="info-box-icon" style="background: #ec4899;">
              <span style="font-size: 11px;">üë§</span>
            </div>
            <div>
              <div class="info-label">T√©cnico</div>
              <div class="info-value">${t.technician.name}</div>
            </div>
          </div>

          <div class="info-box">
            <div class="info-box-icon" style="background: #06b6d4;">
              <span style="font-size: 11px;">üìÖ</span>
            </div>
            <div>
              <div class="info-label">Criado</div>
              <div class="info-value">${new Date(t.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          </div>

          ${showTimer && t.transferredAt ? `
            <div class="timer-box">
              <div style="font-size: 10px; font-weight: 600; letter-spacing: 0.5px; position: relative; z-index: 1;">EM M√ÉOS H√Å</div>
              <div style="display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; position: relative; z-index: 1; margin-top: 4px;">
                <svg class="timer-clock" style="width: 20px; height: 20px;" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                </svg>
                <span id="timer-${t.id}" data-transferred-at="${t.transferredAt}">...</span>
              </div>
            </div>
          ` : ''}

          <div class="progress-container">
            <div class="progress-label">
              <span>Progresso</span>
              <span>${Math.round(progress)}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
          </div>

          <div class="items-compact">
            ${t.items.map(item => `
              <div class="item-compact ${item.status === 'USED' ? 'used' : item.status === 'IN_HANDS' ? 'in-hands' : ''}">
                <div class="item-name">${item.product.name}</div>
                ${item.serialNumber ? `<div class="item-meta">SN: ${item.serialNumber}</div>` : ''}
                ${item.status === 'IN_HANDS' ? `
                  <div class="item-actions">
                    <button onclick="showUseModal(${t.id}, ${item.id})" class="btn-item btn-success-grad">
                      <svg style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      Usado
                    </button>
                    <button onclick="markItemReturned(${t.id}, ${item.id})" class="btn-item btn-info-grad">
                      <svg style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                      </svg>
                      Devolver
                    </button>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>

          <div class="btn-group">
            <button onclick="viewTransfer(${t.id})" class="btn-compact btn-info-grad">
              <svg style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Detalhes
            </button>
            ${t.status === 'PENDING' ? `
              <button onclick="markAsTransferred(${t.id})" class="btn-compact btn-success-grad">
                <svg style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Saiu
              </button>
              <button onclick="cancelTransfer(${t.id})" class="btn-compact btn-danger-grad" title="Cancelar esta sa√≠da">
                <svg style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Cancelar
              </button>
            ` : ''}
            ${['IN_HANDS', 'PARTIALLY_USED', 'USED', 'PARTIALLY_RETURNED'].includes(t.status) ? `
              <button onclick="revertTransfer(${t.id})" class="btn-compact btn-warning-grad" title="Reverter transfer√™ncia e devolver ao estoque">
                <svg style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
                Reverter
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    function updateTimers() {
      document.querySelectorAll('[id^="timer-"]').forEach(timer => {
        const transferredAt = timer.getAttribute('data-transferred-at');
        if (!transferredAt) return;

        const diff = Date.now() - new Date(transferredAt);
        const days = Math.floor(diff / 86400000);
        const hours = Math.floor((diff % 86400000) / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        const secs = Math.floor((diff % 60000) / 1000);

        if (days > 0) {
          timer.textContent = `${days}d ${hours}h ${mins}m`;
        } else if (hours > 0) {
          timer.textContent = `${hours}h ${mins}m ${secs}s`;
        } else if (mins > 0) {
          timer.textContent = `${mins}m ${secs}s`;
        } else {
          timer.textContent = `${secs}s`;
        }
      });
    }

    // Atualizar a cada segundo
    setInterval(updateTimers, 1000);

    function showNewTransferModal() {
      document.getElementById('itemsList').innerHTML = '';
      itemCounter = 0;
      updateItemCounter();
      showModal('newTransferModal');
    }

    function addItemRow() {
      itemCounter++;
      const div = document.createElement('div');
      div.id = `itemRow${itemCounter}`;
      div.className = 'item-row';
      div.innerHTML = `
        <div class="item-row-header">
          <span style="font-weight: 600; color: var(--primary);">Produto #${itemCounter}</span>
          <button type="button" class="remove-btn" onclick="removeItemRow(${itemCounter})">√ó</button>
        </div>
        <div style="position: relative;">
          <input type="text" class="form-control-compact product-search" placeholder="üîç Buscar produto..." onkeyup="searchProduct(${itemCounter}, this.value)">
          <div id="searchResults${itemCounter}" class="search-results"></div>
          <input type="hidden" class="product-id" required>
          <input type="hidden" class="instance-id">
          <div id="selectedProduct${itemCounter}" class="selected-product" style="display: none;"></div>
        </div>
        <div style="margin-top: 10px;">
          <label class="form-label-compact">Quantidade *</label>
          <input type="number" class="form-control-compact quantity" value="1" min="0.01" step="0.01" required>
        </div>
      `;
      document.getElementById('itemsList').appendChild(div);
      updateItemCounter();
    }

    function removeItemRow(id) {
      document.getElementById(`itemRow${id}`).remove();
      updateItemCounter();
    }

    function updateItemCounter() {
      const count = document.getElementById('itemsList').children.length;
      document.getElementById('itemCounter').textContent = `${count} produto(s)`;
    }

    let searchTimeout;
    async function searchProduct(rowId, query) {
      clearTimeout(searchTimeout);
      const resultsDiv = document.getElementById(`searchResults${rowId}`);

      if (query.length < 2) {
        resultsDiv.classList.remove('active');
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/transfers/search-product?q=${encodeURIComponent(query)}`, { credentials: 'include' });
          const instances = await res.json();
          const matchingProds = products.filter(p =>
            (p.name.toLowerCase().includes(query.toLowerCase()) || p.sku.toLowerCase().includes(query.toLowerCase())) && !p.trackSerial
          );

          resultsDiv.innerHTML = '';

          if (instances.length > 0) {
            instances.forEach(inst => {
              const div = document.createElement('div');
              div.className = 'search-item';
              div.innerHTML = `
                <div class="search-title">${inst.product.name}</div>
                <div class="search-meta">SN: ${inst.serialNumber || 'N/A'} ${inst.macAddress ? '‚Ä¢ MAC: ' + inst.macAddress : ''}</div>
              `;
              div.onclick = () => selectProductInstance(rowId, inst);
              resultsDiv.appendChild(div);
            });
          }

          if (matchingProds.length > 0) {
            matchingProds.slice(0, 5).forEach(prod => {
              const div = document.createElement('div');
              div.className = 'search-item';
              div.innerHTML = `
                <div class="search-title">${prod.name}</div>
                <div class="search-meta">SKU: ${prod.sku}</div>
              `;
              div.onclick = () => selectProduct(rowId, prod);
              resultsDiv.appendChild(div);
            });
          }

          if (!instances.length && !matchingProds.length) {
            resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Nenhum resultado</div>';
          }

          resultsDiv.classList.add('active');
        } catch (e) {
          console.error(e);
        }
      }, 300);
    }

    function selectProductInstance(rowId, inst) {
      const row = document.getElementById(`itemRow${rowId}`);
      row.querySelector('.product-id').value = inst.productId;
      row.querySelector('.instance-id').value = inst.id;
      row.querySelector('.product-search').value = '';

      // Armazenar dados da inst√¢ncia nos atributos data-*
      row.setAttribute('data-serial', inst.serialNumber || '');
      row.setAttribute('data-mac', inst.macAddress || '');
      row.setAttribute('data-invoice', inst.invoiceNumber || '');

      document.getElementById(`selectedProduct${rowId}`).innerHTML = `
        <strong style="color: #10b981;">‚úì ${inst.product.name}</strong><br>
        <small>SN: ${inst.serialNumber || 'N/A'}</small>
      `;
      document.getElementById(`selectedProduct${rowId}`).style.display = 'block';
      document.getElementById(`searchResults${rowId}`).classList.remove('active');
    }

    function selectProduct(rowId, prod) {
      const row = document.getElementById(`itemRow${rowId}`);
      row.querySelector('.product-id').value = prod.id;
      row.querySelector('.product-search').value = '';

      document.getElementById(`selectedProduct${rowId}`).innerHTML = `
        <strong style="color: #10b981;">‚úì ${prod.name}</strong><br>
        <small>SKU: ${prod.sku}</small>
      `;
      document.getElementById(`selectedProduct${rowId}`).style.display = 'block';
      document.getElementById(`searchResults${rowId}`).classList.remove('active');
    }

    async function submitTransfer() {
      const techId = parseInt(document.getElementById('technicianId').value);
      if (!techId) return alert('Selecione um t√©cnico');

      const tech = technicians.find(t => t.id === techId);
      if (!tech?.warehouse) return alert('T√©cnico sem almoxarifado');

      const rows = document.querySelectorAll('[id^="itemRow"]');
      const items = [];

      rows.forEach(row => {
        const productId = parseInt(row.querySelector('.product-id').value);
        const instanceId = row.querySelector('.instance-id').value;
        const quantity = parseFloat(row.querySelector('.quantity').value);

        // Ler dados da inst√¢ncia dos atributos data-*
        const serialNumber = row.getAttribute('data-serial');
        const macAddress = row.getAttribute('data-mac');
        const invoiceNumber = row.getAttribute('data-invoice');

        if (productId && quantity > 0) {
          items.push({
            productId,
            productInstanceId: instanceId ? parseInt(instanceId) : undefined,
            serialNumber: serialNumber || undefined,
            macAddress: macAddress || undefined,
            invoiceNumber: invoiceNumber || undefined,
            quantity
          });
        }
      });

      if (!items.length) return alert('Adicione pelo menos um produto');

      try {
        const res = await fetch('/transfers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            fromWarehouseId: 1,
            toWarehouseId: tech.warehouse.id,
            technicianId: techId,
            items,
            note: document.getElementById('note').value || undefined
          })
        });

        if (res.ok) {
          showAlert('Transfer√™ncia criada!', 'success');
          hideModal('newTransferModal');
          loadData();
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao criar', 'error');
        }
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    async function markAsTransferred(id) {
      if (!confirm('Confirmar sa√≠da do almoxarifado?')) return;

      try {
        const res = await fetch(`/transfers/${id}/transfer`, {
          method: 'PATCH',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Marcado como em m√£os!', 'success');
          loadData();
        }
      } catch (e) {
        showAlert('Erro', 'error');
      }
    }

    async function revertTransfer(id) {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° reverter a transfer√™ncia e devolver os produtos ao estoque principal. Deseja continuar?')) return;

      try {
        const res = await fetch(`/transfers/${id}/revert`, {
          method: 'PATCH',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Transfer√™ncia revertida com sucesso! Produtos devolvidos ao estoque.', 'success');
          loadData();
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao reverter transfer√™ncia', 'error');
        }
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    async function cancelTransfer(id) {
      if (!confirm('‚ö†Ô∏è Tem certeza que deseja cancelar esta sa√≠da? Esta a√ß√£o n√£o pode ser desfeita.')) return;

      try {
        const res = await fetch(`/transfers/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: 'CANCELED' })
        });

        if (res.ok) {
          showAlert('Sa√≠da cancelada com sucesso!', 'success');
          loadData();
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao cancelar sa√≠da', 'error');
        }
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    async function deleteTransfer(id, number) {
      if (!confirm(`Tem certeza que deseja apagar a transfer√™ncia ${number}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }

      try {
        const response = await fetch(`/transfers/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Erro ao apagar transfer√™ncia');
        }

        showAlert(`Transfer√™ncia ${number} apagada com sucesso!`, 'success');
        await loadData();
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    function viewTransfer(id) {
      currentTransferId = id;
      const t = transfers.find(x => x.id === id);
      if (!t) return;

      const status = STATUS_MAP[t.status];

      document.getElementById('detailTitle').textContent = `Transfer√™ncia ${t.number}`;
      document.getElementById('detailContent').innerHTML = `
        <div class="detail-section">
          <div class="detail-grid">
            <div>
              <div class="detail-item-label">T√âCNICO</div>
              <div class="detail-item-value">${t.technician.name}</div>
            </div>
            <div>
              <div class="detail-item-label">STATUS</div>
              <span class="badge badge-${status.color}">${status.label}</span>
            </div>
            <div>
              <div class="detail-item-label">CRIADO EM</div>
              <div class="detail-item-value">${new Date(t.createdAt).toLocaleString('pt-BR')}</div>
            </div>
            ${t.transferredAt ? `
              <div>
                <div class="detail-item-label">SAIU EM</div>
                <div class="detail-item-value">${new Date(t.transferredAt).toLocaleString('pt-BR')}</div>
              </div>
            ` : ''}
          </div>
          ${t.note ? `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.1);">
              <div class="detail-item-label">OBSERVA√á√ïES</div>
              <div style="color: #94a3b8; font-size: 13px;">${t.note}</div>
            </div>
          ` : ''}
        </div>

        <div>
          <div style="font-size: 13px; font-weight: 700; color: #94a3b8; margin-bottom: 10px;">
            üì¶ ITENS (${t.items.length})
          </div>
          ${t.items.map(item => {
            const itemStatus = ITEM_STATUS_MAP[item.status];
            return `
              <div class="detail-section" style="border-left-color: ${itemStatus.color === 'success' ? '#10b981' : itemStatus.color === 'warning' ? '#fbbf24' : '#3b82f6'}">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="font-size: 14px;">${item.product.name}</strong>
                  <span class="badge badge-${itemStatus.color}">${itemStatus.label}</span>
                </div>
                ${item.serialNumber ? `<div style="font-size: 12px; color: #64748b;">SN: ${item.serialNumber}</div>` : ''}
                ${item.macAddress ? `<div style="font-size: 12px; color: #64748b;">MAC: ${item.macAddress}</div>` : ''}
                ${item.ixcClientCode ? `<div style="font-size: 12px; color: #64748b;">Cliente: ${item.ixcClientCode}</div>` : ''}
                ${item.usageNote ? `<div style="margin-top: 8px; padding: 8px; background: rgba(148, 163, 184, 0.1); border-radius: 4px; font-size: 12px;">üí¨ ${item.usageNote}</div>` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;

      showModal('detailModal');
    }

    function showUseModal(transferId, itemId) {
      currentTransferId = transferId;
      document.getElementById('useItemId').value = itemId;
      document.getElementById('useForm').reset();
      document.getElementById('useItemId').value = itemId;
      showModal('useModal');
    }

    async function submitUse() {
      const itemId = parseInt(document.getElementById('useItemId').value);
      const ixcClientCode = document.getElementById('ixcClientCode').value;
      const usageNote = document.getElementById('usageNote').value;

      try {
        const res = await fetch(`/transfers/${currentTransferId}/items/${itemId}/use`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ixcClientCode, usageNote })
        });

        if (res.ok) {
          showAlert('Item marcado como usado!', 'success');
          hideModal('useModal');
          loadData();
        }
      } catch (e) {
        showAlert('Erro', 'error');
      }
    }

    async function markItemReturned(transferId, itemId) {
      if (!confirm('Confirmar devolu√ß√£o?')) return;

      try {
        const res = await fetch(`/transfers/${transferId}/items/${itemId}/return`, {
          method: 'PATCH',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Item devolvido!', 'success');
          loadData();
        }
      } catch (e) {
        showAlert('Erro', 'error');
      }
    }

    function showModal(id) {
      document.getElementById(id).style.display = 'block';
    }

    function hideModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function showAlert(message, type) {
      alert(message);
    }

    init();
  </script>
</body>
</html>
