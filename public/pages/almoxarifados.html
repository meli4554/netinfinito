<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Almoxarifados - NetInFi</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .warehouses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .warehouse-card {
      background: linear-gradient(135deg, var(--surface) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .warehouse-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--info));
    }

    .warehouse-card.technician::before {
      background: linear-gradient(90deg, var(--warning), var(--success));
    }

    .warehouse-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border-color: var(--primary);
    }

    .warehouse-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
    }

    .warehouse-code {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Courier New', monospace;
    }

    .warehouse-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .warehouse-type-badge.main {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .warehouse-type-badge.technician {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .warehouse-name {
      font-size: 16px;
      font-weight: 500;
      margin: 12px 0;
      color: var(--text);
    }

    .warehouse-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 16px 0;
      padding: 12px;
      background: var(--background);
      border-radius: 8px;
    }

    .warehouse-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .warehouse-info-item strong {
      color: var(--text);
    }

    .warehouse-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn-modern {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      justify-content: center;
      min-width: 100px;
    }

    .btn-view {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-view:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }

    .btn-edit {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-edit:hover {
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
      transform: translateY(-2px);
    }

    .btn-delete {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    .btn-delete:hover {
      box-shadow: 0 4px 12px rgba(250, 112, 154, 0.4);
      transform: translateY(-2px);
    }

    .stock-grid {
      display: grid;
      gap: 16px;
      margin-top: 20px;
    }

    .stock-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .stock-section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
      color: var(--text);
    }

    .product-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      padding: 16px;
      background: var(--background);
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
      align-items: center;
    }

    .product-item:hover {
      background: var(--surface);
      transform: translateX(4px);
    }

    .product-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .product-details {
      flex: 1;
    }

    .product-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .product-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-muted);
    }

    .product-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .product-quantity {
      font-size: 20px;
      font-weight: 700;
      color: var(--success);
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .transfer-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn-sm {
      transition: all 0.2s ease;
      font-weight: 500;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-sm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
      filter: brightness(1.1);
    }

    .btn-sm svg {
      transition: transform 0.2s ease;
    }

    .btn-sm:hover svg {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/pages/dashboard.html" class="logo">
          <div class="logo-icon">NI</div>
          <span>NetInFi</span>
        </a>
        <nav class="nav">
          <a href="/pages/dashboard.html" class="nav-link">Dashboard</a>
          <a href="/pages/products.html" class="nav-link">Produtos</a>
          <a href="/pages/technicians.html" class="nav-link">T√©cnicos</a>
          <a href="/pages/almoxarifados.html" class="nav-link active">Almoxarifados</a>
          <a href="/pages/transfers.html" class="nav-link">Transfer√™ncias</a>
          <a href="/pages/reports.html" class="nav-link">Relat√≥rios</a>
          <a href="#" onclick="AuthService.logout(); return false;" class="nav-link">Sair</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top: 30px;">
    <div class="card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="card-title">Almoxarifados</h2>
        <button class="btn btn-primary" onclick="showModal()">+ Novo Almoxarifado</button>
      </div>
      <div id="table">
        <div style="text-align: center; padding: 40px;">
          <div class="loading" style="margin: 0 auto;"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Criar/Editar Almoxarifado -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Novo Almoxarifado</h3>
        <span class="close" onclick="hideModal()">&times;</span>
      </div>
      <form id="form">
        <input type="hidden" id="id">

        <div class="form-group">
          <label class="form-label">Nome *</label>
          <input type="text" id="name" class="form-control" placeholder="Ex: Almoxarifado Central" required>
        </div>

        <div class="form-group">
          <label class="form-label">C√≥digo *</label>
          <input type="text" id="code" class="form-control" placeholder="Ex: ALM-001" required>
          <small style="color: var(--text-muted); font-size: 12px;">C√≥digo √∫nico para identifica√ß√£o</small>
        </div>

        <div class="form-group">
          <label class="form-label">Tipo *</label>
          <select id="type" class="form-control" required onchange="toggleTechnicianField()">
            <option value="">Selecione...</option>
            <option value="MAIN">Principal</option>
            <option value="TECHNICIAN">T√©cnico</option>
          </select>
        </div>

        <div class="form-group" id="technicianGroup" style="display: none;">
          <label class="form-label">T√©cnico</label>
          <select id="technicianId" class="form-control">
            <option value="">Selecione um t√©cnico...</option>
          </select>
          <small style="color: var(--text-muted); font-size: 12px;">Associe este almoxarifado a um t√©cnico</small>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ver Estoque -->
  <div id="stockModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="stockModalTitle">Estoque do Almoxarifado</h3>
        <span class="close" onclick="hideStockModal()">&times;</span>
      </div>
      <div id="stockContent">
        <div style="text-align: center; padding: 40px;">
          <div class="loading" style="margin: 0 auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    let data = [];
    let technicians = [];

    const TYPE_LABELS = {
      MAIN: 'Principal',
      TECHNICIAN: 'T√©cnico'
    };

    async function init() {
      await AuthService.requireAuth();
      await loadTechnicians();
      load();
    }

    async function loadTechnicians() {
      try {
        const res = await fetch('/technicians', { credentials: 'include' });
        technicians = await res.json();
        updateTechnicianSelect();
      } catch (e) {
        console.error('Erro ao carregar t√©cnicos:', e);
      }
    }

    function updateTechnicianSelect() {
      const select = document.getElementById('technicianId');
      select.innerHTML = '<option value="">Selecione um t√©cnico...</option>' +
        technicians.filter(t => t.isActive && !t.warehouse).map(t =>
          `<option value="${t.id}">${t.name}</option>`
        ).join('');
    }

    async function load() {
      try {
        const res = await fetch('/warehouses', { credentials: 'include' });
        data = await res.json();
        render();
      } catch (e) {
        document.getElementById('table').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar</p>';
      }
    }

    function render() {
      const el = document.getElementById('table');
      if (!data.length) {
        el.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum almoxarifado cadastrado</p>';
        return;
      }

      el.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nome</th>
              <th>Tipo</th>
              <th>T√©cnico</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(w => `
              <tr>
                <td><strong>${w.code}</strong></td>
                <td>${w.name}</td>
                <td>
                  <span class="badge ${w.type === 'MAIN' ? 'badge-primary' : 'badge-info'}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      ${w.type === 'MAIN' ? '<rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>' : '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'}
                    </svg>
                    ${TYPE_LABELS[w.type]}
                  </span>
                </td>
                <td>${w.technician ? w.technician.name : '-'}</td>
                <td>
                  <button class="btn btn-sm" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white; border: none;" onclick="viewStock(${w.id}, '${w.name}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                    Ver Estoque
                  </button>
                  <button class="btn btn-sm" style="background: linear-gradient(135deg, #1a252f 0%, #2980b9 100%); color: white; border: none;" onclick="edit(${w.id})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Editar
                  </button>
                  <button class="btn btn-sm" style="background: linear-gradient(135deg, #34495e 0%, #e74c3c 100%); color: white; border: none;" onclick="confirmDelete(${w.id}, '${w.name.replace(/'/g, "\\'")}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Excluir
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function toggleTechnicianField() {
      const type = document.getElementById('type').value;
      const techGroup = document.getElementById('technicianGroup');

      if (type === 'TECHNICIAN') {
        techGroup.style.display = 'block';
      } else {
        techGroup.style.display = 'none';
        document.getElementById('technicianId').value = '';
      }
    }

    function showModal() {
      document.getElementById('modalTitle').textContent = 'Novo Almoxarifado';
      document.getElementById('form').reset();
      document.getElementById('id').value = '';
      document.getElementById('technicianGroup').style.display = 'none';
      updateTechnicianSelect();
      document.getElementById('modal').style.display = 'block';
    }

    function edit(id) {
      const w = data.find(x => x.id === id);
      if (!w) return;

      document.getElementById('modalTitle').textContent = 'Editar Almoxarifado';
      document.getElementById('id').value = w.id;
      document.getElementById('name').value = w.name;
      document.getElementById('code').value = w.code;
      document.getElementById('type').value = w.type;

      toggleTechnicianField();

      if (w.type === 'TECHNICIAN') {
        // Se estiver editando, incluir o t√©cnico atual na lista
        updateTechnicianSelect();
        if (w.technician) {
          const select = document.getElementById('technicianId');
          if (!select.querySelector(`option[value="${w.technician.id}"]`)) {
            const option = document.createElement('option');
            option.value = w.technician.id;
            option.textContent = w.technician.name;
            select.appendChild(option);
          }
          select.value = w.technician.id;
        }
      }

      document.getElementById('modal').style.display = 'block';
    }

    function hideModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function viewStock(id, name) {
      document.getElementById('stockModalTitle').textContent = `Estoque: ${name}`;
      document.getElementById('stockModal').style.display = 'block';
      document.getElementById('stockContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';

      try {
        const res = await fetch(`/warehouses/${id}/stock`, { credentials: 'include' });
        const stock = await res.json();
        renderStock(stock);
      } catch (e) {
        console.error(e);
        document.getElementById('stockContent').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar estoque</p>';
      }
    }

    function renderStock(stock) {
      const { warehouse, transfers } = stock;

      let html = '<div style="padding: 20px;">';

      // Informa√ß√µes do almoxarifado
      html += `
        <div style="background: var(--background); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0;">Informa√ß√µes</h4>
          <p style="margin: 5px 0;"><strong>C√≥digo:</strong> ${warehouse.code}</p>
          <p style="margin: 5px 0;"><strong>Tipo:</strong> ${TYPE_LABELS[warehouse.type]}</p>
          ${warehouse.technician ? `<p style="margin: 5px 0;"><strong>T√©cnico:</strong> ${warehouse.technician.name}</p>` : ''}
          <p style="margin: 5px 0;"><strong>Localiza√ß√µes:</strong> ${warehouse.locations.length}</p>
        </div>
      `;

      // Movimentos por localiza√ß√£o
      if (warehouse.locations.length > 0) {
        html += '<h4 style="margin: 20px 0 10px 0;">Movimentos por Localiza√ß√£o</h4>';
        warehouse.locations.forEach(loc => {
          if (loc.movements.length > 0) {
            html += `
              <div style="background: var(--surface); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border);">
                <h5 style="margin: 0 0 10px 0;">${loc.code} ${loc.description ? `- ${loc.description}` : ''}</h5>
                <div style="max-height: 200px; overflow-y: auto;">
                  ${loc.movements.slice(0, 10).map(m => `
                    <div style="padding: 8px; border-bottom: 1px solid var(--border); font-size: 13px;">
                      <strong>${m.product.name}</strong><br>
                      <small style="color: var(--text-muted);">
                        Tipo: ${m.type} | Qtd: ${m.quantity} |
                        ${new Date(m.occurredAt).toLocaleDateString('pt-BR')}
                      </small>
                    </div>
                  `).join('')}
                  ${loc.movements.length > 10 ? `<p style="text-align: center; color: var(--text-muted); font-size: 12px; margin: 10px 0;">+${loc.movements.length - 10} movimento(s)</p>` : ''}
                </div>
              </div>
            `;
          }
        });
      }

      // Transfer√™ncias em andamento (para t√©cnicos)
      if (transfers && transfers.length > 0) {
        html += '<h4 style="margin: 20px 0 10px 0;">Transfer√™ncias Em Andamento</h4>';
        transfers.forEach(t => {
          const inHandsItems = t.items.filter(i => i.status === 'IN_HANDS' || i.status === 'PENDING');
          if (inHandsItems.length > 0) {
            html += `
              <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h5 style="margin: 0 0 10px 0;">üì¶ ${t.number}</h5>
                ${inHandsItems.map(item => `
                  <div style="padding: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin: 5px 0;">
                    <strong>${item.product.name}</strong> - Qtd: ${item.quantity}
                    ${item.serialNumber ? `<br><small>SN: ${item.serialNumber}</small>` : ''}
                    ${item.macAddress ? `<br><small>MAC: ${item.macAddress}</small>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
        });
      }

      if (warehouse.locations.length === 0 && (!transfers || transfers.length === 0)) {
        html += '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum item no estoque</p>';
      }

      html += '</div>';
      document.getElementById('stockContent').innerHTML = html;
    }

    function hideStockModal() {
      document.getElementById('stockModal').style.display = 'none';
    }

    async function confirmDelete(id, name) {
      if (!confirm(`Tem certeza que deseja EXCLUIR o almoxarifado "${name}"?\\n\\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;

      try {
        const res = await fetch(`/warehouses/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Almoxarifado exclu√≠do com sucesso!', 'success');
          load();
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao excluir almoxarifado', 'error');
        }
      } catch (e) {
        showAlert('Erro ao excluir almoxarifado', 'error');
      }
    }

    document.getElementById('form').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('id').value;

      const payload = {
        name: document.getElementById('name').value,
        code: document.getElementById('code').value,
        type: document.getElementById('type').value,
        technicianId: document.getElementById('technicianId').value ? parseInt(document.getElementById('technicianId').value) : null
      };

      try {
        const res = await fetch(id ? `/warehouses/${id}` : '/warehouses', {
          method: id ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          showAlert(id ? 'Almoxarifado atualizado!' : 'Almoxarifado criado!', 'success');
          hideModal();
          load();
          loadTechnicians(); // Recarregar t√©cnicos para atualizar a lista
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao salvar', 'error');
        }
      } catch (e) {
        showAlert('Erro ao salvar', 'error');
      }
    };

    // Modal s√≥ fecha ao clicar no X
    // window.onclick = (e) => {
    //   if (e.target.id === 'modal') hideModal();
    //   if (e.target.id === 'stockModal') hideStockModal();
    // };

    init();
  </script>
</body>
</html>
