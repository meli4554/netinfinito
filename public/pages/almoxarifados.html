<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Almoxarifados - RCONTROL</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .warehouses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .warehouse-card {
      background: linear-gradient(135deg, var(--surface) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .warehouse-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--info));
    }

    .warehouse-card.technician::before {
      background: linear-gradient(90deg, var(--warning), var(--success));
    }

    .warehouse-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border-color: var(--primary);
    }

    .warehouse-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
    }

    .warehouse-code {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Courier New', monospace;
    }

    .warehouse-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .warehouse-type-badge.main {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .warehouse-type-badge.technician {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .warehouse-name {
      font-size: 16px;
      font-weight: 500;
      margin: 12px 0;
      color: var(--text);
    }

    .warehouse-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 16px 0;
      padding: 12px;
      background: var(--background);
      border-radius: 8px;
    }

    .warehouse-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .warehouse-info-item strong {
      color: var(--text);
    }

    .warehouse-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn-modern {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      justify-content: center;
      min-width: 100px;
    }

    .btn-view {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-view:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }

    .btn-edit {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-edit:hover {
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
      transform: translateY(-2px);
    }

    .btn-delete {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    .btn-delete:hover {
      box-shadow: 0 4px 12px rgba(250, 112, 154, 0.4);
      transform: translateY(-2px);
    }

    .stock-grid {
      display: grid;
      gap: 16px;
      margin-top: 20px;
    }

    .stock-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .stock-section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
      color: var(--text);
    }

    .product-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      padding: 16px;
      background: var(--background);
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
      align-items: center;
    }

    .product-item:hover {
      background: var(--surface);
      transform: translateX(4px);
    }

    .product-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .product-details {
      flex: 1;
    }

    .product-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .product-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-muted);
    }

    .product-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .product-quantity {
      font-size: 20px;
      font-weight: 700;
      color: var(--success);
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .transfer-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn-sm {
      transition: all 0.2s ease;
      font-weight: 500;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-sm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
      filter: brightness(1.1);
    }

    .btn-sm svg {
      transition: transform 0.2s ease;
    }

    .btn-sm:hover svg {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/pages/dashboard.html" class="logo">
          <div class="logo-icon">R</div>
          <span>CONTROL</span>
        </a>

        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <nav class="nav" id="navMenu">
          <a href="/pages/dashboard.html" class="nav-link">Dashboard</a>
          <a href="/pages/products.html" class="nav-link">Produtos</a>
          <a href="/pages/technicians.html" class="nav-link">T√©cnicos</a>
          <a href="/pages/almoxarifados.html" class="nav-link active">Almoxarifados</a>
          <a href="/pages/transfers.html" class="nav-link">Sa√≠da</a>
          <a href="/pages/contabilizacao.html" class="nav-link">Contabiliza√ß√£o</a>
          <a href="#" onclick="AuthService.logout(); return false;" class="nav-link">Sair</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top: 30px;">
    <div class="card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="card-title">Almoxarifados</h2>
        <button class="btn btn-primary" onclick="showModal()">+ Novo Almoxarifado</button>
      </div>
      <div id="table">
        <div style="text-align: center; padding: 40px;">
          <div class="loading" style="margin: 0 auto;"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Criar/Editar Almoxarifado -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Novo Almoxarifado</h3>
        <span class="close" onclick="hideModal()">&times;</span>
      </div>
      <form id="form">
        <input type="hidden" id="id">

        <div class="form-group">
          <label class="form-label">Nome *</label>
          <input type="text" id="name" class="form-control" placeholder="Ex: Almoxarifado Central" required>
        </div>

        <div class="form-group">
          <label class="form-label">C√≥digo *</label>
          <input type="text" id="code" class="form-control" placeholder="Ex: ALM-001" required>
          <small style="color: var(--text-muted); font-size: 12px;">C√≥digo √∫nico para identifica√ß√£o</small>
        </div>

        <div class="form-group">
          <label class="form-label">Tipo *</label>
          <select id="type" class="form-control" required onchange="toggleTechnicianField()">
            <option value="">Selecione...</option>
            <option value="MAIN">Principal</option>
            <option value="TECHNICIAN">T√©cnico</option>
          </select>
        </div>

        <div class="form-group" id="technicianGroup" style="display: none;">
          <label class="form-label">T√©cnico</label>
          <select id="technicianId" class="form-control">
            <option value="">Selecione um t√©cnico...</option>
          </select>
          <small style="color: var(--text-muted); font-size: 12px;">Associe este almoxarifado a um t√©cnico</small>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ver Estoque -->
  <div id="stockModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="stockModalTitle">Estoque do Almoxarifado</h3>
        <span class="close" onclick="hideStockModal()">&times;</span>
      </div>
      <div id="stockContent">
        <div style="text-align: center; padding: 40px;">
          <div class="loading" style="margin: 0 auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/menu.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let data = [];
    let technicians = [];

    const TYPE_LABELS = {
      MAIN: 'Principal',
      TECHNICIAN: 'T√©cnico'
    };

    async function init() {
      await AuthService.requireAuth();
      await loadTechnicians();
      load();
    }

    async function loadTechnicians() {
      try {
        const res = await fetch('/technicians', { credentials: 'include' });
        technicians = await res.json();
        updateTechnicianSelect();
      } catch (e) {
        console.error('Erro ao carregar t√©cnicos:', e);
      }
    }

    function updateTechnicianSelect() {
      const select = document.getElementById('technicianId');
      select.innerHTML = '<option value="">Selecione um t√©cnico...</option>' +
        technicians.filter(t => t.isActive && !t.warehouse).map(t =>
          `<option value="${t.id}">${t.name}</option>`
        ).join('');
    }

    async function load() {
      try {
        const res = await fetch('/warehouses', { credentials: 'include' });
        data = await res.json();
        render();
      } catch (e) {
        document.getElementById('table').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar</p>';
      }
    }

    function render() {
      const el = document.getElementById('table');
      if (!data.length) {
        el.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum almoxarifado cadastrado</p>';
        return;
      }

      el.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nome</th>
              <th>Tipo</th>
              <th>T√©cnico</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(w => `
              <tr>
                <td><strong>${w.code}</strong></td>
                <td>${w.name}</td>
                <td>
                  <span class="badge ${w.type === 'MAIN' ? 'badge-primary' : 'badge-info'}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      ${w.type === 'MAIN' ? '<rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>' : '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'}
                    </svg>
                    ${TYPE_LABELS[w.type]}
                  </span>
                </td>
                <td>${w.technician ? w.technician.name : '-'}</td>
                <td>
                  <button class="btn btn-sm" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white; border: none;" onclick="viewStock(${w.id}, '${w.name}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                    Ver Estoque
                  </button>
                  <button class="btn btn-sm" style="background: linear-gradient(135deg, #1a252f 0%, #2980b9 100%); color: white; border: none;" onclick="edit(${w.id})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Editar
                  </button>
                  ${w.type !== 'MAIN' ? `
                  <button class="btn btn-sm" style="background: linear-gradient(135deg, #34495e 0%, #e74c3c 100%); color: white; border: none;" onclick="confirmDelete(${w.id}, '${w.name.replace(/'/g, "\\'")}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                      <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Excluir
                  </button>
                  ` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function toggleTechnicianField() {
      const type = document.getElementById('type').value;
      const techGroup = document.getElementById('technicianGroup');

      if (type === 'TECHNICIAN') {
        techGroup.style.display = 'block';
      } else {
        techGroup.style.display = 'none';
        document.getElementById('technicianId').value = '';
      }
    }

    function showModal() {
      document.getElementById('modalTitle').textContent = 'Novo Almoxarifado';
      document.getElementById('form').reset();
      document.getElementById('id').value = '';
      document.getElementById('technicianGroup').style.display = 'none';
      updateTechnicianSelect();
      document.getElementById('modal').style.display = 'block';
    }

    function edit(id) {
      const w = data.find(x => x.id === id);
      if (!w) return;

      document.getElementById('modalTitle').textContent = 'Editar Almoxarifado';
      document.getElementById('id').value = w.id;
      document.getElementById('name').value = w.name;
      document.getElementById('code').value = w.code;
      document.getElementById('type').value = w.type;

      toggleTechnicianField();

      if (w.type === 'TECHNICIAN') {
        // Se estiver editando, incluir o t√©cnico atual na lista
        updateTechnicianSelect();
        if (w.technician) {
          const select = document.getElementById('technicianId');
          if (!select.querySelector(`option[value="${w.technician.id}"]`)) {
            const option = document.createElement('option');
            option.value = w.technician.id;
            option.textContent = w.technician.name;
            select.appendChild(option);
          }
          select.value = w.technician.id;
        }
      }

      document.getElementById('modal').style.display = 'block';
    }

    function hideModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function viewStock(id, name) {
      document.getElementById('stockModalTitle').textContent = `Estoque: ${name}`;
      document.getElementById('stockModal').style.display = 'block';
      document.getElementById('stockContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div></div>';

      try {
        const res = await fetch(`/warehouses/${id}/stock`, { credentials: 'include' });
        const stock = await res.json();
        renderStock(stock);
      } catch (e) {
        console.error(e);
        document.getElementById('stockContent').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar estoque</p>';
      }
    }

    function renderStock(stock) {
      const { warehouse, products, transfers } = stock;

      let html = '<div style="padding: 20px;">';

      // Informa√ß√µes do almoxarifado
      html += `
        <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.4);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin: 0 0 8px 0; font-size: 24px;">${warehouse.name}</h3>
              <p style="margin: 0; opacity: 0.7;"><strong>C√≥digo:</strong> ${warehouse.code} | <strong>Tipo:</strong> ${TYPE_LABELS[warehouse.type]}</p>
              ${warehouse.technician ? `<p style="margin: 5px 0 0 0; opacity: 0.7;">üë§ ${warehouse.technician.name}</p>` : ''}
            </div>
            <div style="text-align: center; background: rgba(16, 185, 129, 0.15); padding: 15px 25px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
              <div style="font-size: 32px; font-weight: 700; color: #10b981;">${products.length}</div>
              <div style="font-size: 13px; opacity: 0.9; margin-top: 4px; color: #10b981;">Produtos</div>
            </div>
          </div>
        </div>
      `;

      // Grid de Produtos
      if (products && products.length > 0) {
        html += '<h4 style="margin: 25px 0 15px 0; font-size: 18px; color: var(--text);">üì¶ Produtos em Estoque</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';

        products.forEach(product => {
          const stockPercentage = product.minStock > 0 ? (product.currentStock / product.minStock) * 100 : 100;
          const stockStatus = product.currentStock <= product.minStock ? 'low' : 'ok';
          const statusColor = stockStatus === 'low' ? '#e74c3c' : '#27ae60';
          const statusLabel = stockStatus === 'low' ? 'BAIXO' : 'OK';

          html += `
            <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: all 0.3s ease; position: relative; overflow: hidden;">
              <!-- Status Badge -->
              <div style="position: absolute; top: 15px; right: 15px;">
                <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                  ${statusLabel}
                </span>
              </div>

              <!-- SKU -->
              <div style="font-family: 'Courier New', monospace; font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                ${product.sku}
              </div>

              <!-- Nome do Produto -->
              <h5 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: var(--text); line-height: 1.4;">
                ${product.name}
              </h5>

              <!-- Informa√ß√µes de Estoque -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                <div style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">UNIDADE</div>
                  <div style="font-size: 16px; font-weight: 700; color: #3498db;">${product.unit}</div>
                </div>
                <div style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ESTOQUE</div>
                  <div style="font-size: 20px; font-weight: 700; color: ${statusColor};">${product.currentStock}</div>
                </div>
                <div style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">M√çNIMO</div>
                  <div style="font-size: 16px; font-weight: 700; color: var(--text-muted);">${product.minStock || 0}</div>
                </div>
              </div>

              <!-- Barra de Progresso -->
              ${product.minStock > 0 ? `
                <div style="background: var(--background); height: 8px; border-radius: 10px; overflow: hidden; margin-top: 12px;">
                  <div style="background: linear-gradient(90deg, ${statusColor}, ${statusColor === '#e74c3c' ? '#c0392b' : '#229954'}); height: 100%; width: ${Math.min(stockPercentage, 100)}%; transition: width 0.3s ease;"></div>
                </div>
              ` : ''}
            </div>
          `;
        });

        html += '</div>';
      }

      // Sa√≠das em andamento (para t√©cnicos)
      if (transfers && transfers.length > 0) {
        html += '<h4 style="margin: 30px 0 15px 0; font-size: 18px; color: var(--text);">üöö Sa√≠das Em Andamento</h4>';
        transfers.forEach(t => {
          const inHandsItems = t.items.filter(i => i.status === 'IN_HANDS' || i.status === 'PENDING');
          if (inHandsItems.length > 0) {
            const transferDate = new Date(t.transferredAt || t.createdAt).toLocaleString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            html += `
              <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <div>
                    <h5 style="margin: 0; font-size: 17px; font-weight: 700;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                      </svg>
                      ${t.number}
                    </h5>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 6px; font-weight: 500;">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                      </svg>
                      ${transferDate}
                    </div>
                  </div>
                  <span style="background: rgba(16, 185, 129, 0.15); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981;">
                    ${inHandsItems.length} ${inHandsItems.length === 1 ? 'item' : 'itens'}
                  </span>
                </div>
                <div style="display: grid; gap: 12px;">
                  ${inHandsItems.map((item, idx) => {
                    const statusBadgeColor = item.status === 'IN_HANDS' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                    const statusBadgeBorder = item.status === 'IN_HANDS' ? 'rgba(16, 185, 129, 0.4)' : 'rgba(245, 158, 11, 0.4)';
                    const statusTextColor = item.status === 'IN_HANDS' ? '#10b981' : '#f59e0b';
                    const statusText = item.status === 'IN_HANDS' ? 'EM M√ÉOS' : 'PENDENTE';
                    const itemId = `transfer-item-${t.id}-${idx}`;

                    return `
                    <div style="background: rgba(0,0,0,0.3); padding: 18px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                      <!-- Cabe√ßalho do Item -->
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 14px;">
                        <div style="flex: 1;">
                          <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${item.product.name}</div>
                          <div style="font-family: 'Courier New', monospace; font-size: 11px; opacity: 0.7; background: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.1);">SKU: ${item.product.sku}</div>
                          <div style="font-size: 14px; font-weight: 600; margin-top: 8px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/>
                            </svg>
                            Quantidade: <strong style="font-size: 15px;">${item.quantity} ${item.product.unit}</strong>
                          </div>
                        </div>
                        <span style="background: ${statusBadgeColor}; border: 1px solid ${statusBadgeBorder}; color: ${statusTextColor}; padding: 6px 12px; border-radius: 14px; font-size: 11px; font-weight: 700; white-space: nowrap; margin-left: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                          ${statusText}
                        </span>
                      </div>

                      <!-- Bot√£o Ver Detalhes -->
                      <button
                        onclick="toggleItemDetails('${itemId}')"
                        style="width: 100%; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"
                        onmouseover="this.style.background='rgba(16, 185, 129, 0.2)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'"
                        onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)'"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                          <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <span id="${itemId}-btn-text">Ver Detalhes</span>
                      </button>

                      <!-- Detalhes em Grid (inicialmente oculto) -->
                      <div id="${itemId}" style="display: none; margin-top: 14px; animation: fadeIn 0.3s ease;">
                        <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15);">
                          <div style="display: grid; gap: 12px;">
                            ${item.serialNumber ? `
                            <!-- Serial Number -->
                            <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; border-left: 3px solid #10b981;">
                              <div style="background: rgba(16, 185, 129, 0.15); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                                </svg>
                              </div>
                              <div style="flex: 1;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 3px; font-weight: 600; letter-spacing: 0.5px;">N√öMERO DE S√âRIE</div>
                                <div style="font-size: 14px; font-weight: 700; font-family: 'Courier New', monospace; color: #10b981;">${item.serialNumber}</div>
                              </div>
                            </div>
                            ` : ''}

                            ${item.macAddress ? `
                            <!-- MAC Address -->
                            <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; border-left: 3px solid #3b82f6;">
                              <div style="background: rgba(59, 130, 246, 0.15); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                              </div>
                              <div style="flex: 1;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 3px; font-weight: 600; letter-spacing: 0.5px;">ENDERE√áO MAC</div>
                                <div style="font-size: 14px; font-weight: 700; font-family: 'Courier New', monospace; color: #3b82f6;">${item.macAddress}</div>
                              </div>
                            </div>
                            ` : ''}

                            ${item.invoiceNumber ? `
                            <!-- Invoice Number -->
                            <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; border-left: 3px solid #f59e0b;">
                              <div style="background: rgba(245, 158, 11, 0.15); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                                </svg>
                              </div>
                              <div style="flex: 1;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 3px; font-weight: 600; letter-spacing: 0.5px;">NOTA FISCAL</div>
                                <div style="font-size: 14px; font-weight: 700; color: #f59e0b;">${item.invoiceNumber}</div>
                              </div>
                            </div>
                            ` : ''}

                            ${item.ixcClientCode ? `
                            <!-- IXC Client Code -->
                            <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; border-left: 3px solid #06b6d4;">
                              <div style="background: rgba(6, 182, 212, 0.15); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2">
                                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                              </div>
                              <div style="flex: 1;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 3px; font-weight: 600; letter-spacing: 0.5px;">C√ìDIGO CLIENTE IXC</div>
                                <div style="font-size: 14px; font-weight: 700; color: #06b6d4;">${item.ixcClientCode}</div>
                              </div>
                            </div>
                            ` : ''}

                            ${item.usageNote ? `
                            <!-- Usage Note -->
                            <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 6px; display: flex; align-items: start; gap: 10px; border-left: 3px solid #8b5cf6;">
                              <div style="background: rgba(139, 92, 246, 0.15); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                                </svg>
                              </div>
                              <div style="flex: 1;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 3px; font-weight: 600; letter-spacing: 0.5px;">OBSERVA√á√ïES</div>
                                <div style="font-size: 13px; line-height: 1.5; opacity: 0.95;">${item.usageNote}</div>
                              </div>
                            </div>
                            ` : ''}

                            ${!item.serialNumber && !item.macAddress && !item.invoiceNumber && !item.ixcClientCode && !item.usageNote ? `
                            <div style="text-align: center; padding: 30px; opacity: 0.7;">
                              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 12px; opacity: 0.5;">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                              </svg>
                              <div style="font-size: 14px; font-weight: 600;">Nenhum detalhe adicional dispon√≠vel</div>
                            </div>
                            ` : ''}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                  }).join('')}
                </div>
              </div>
            `;
          }
        });
      }

      if ((!products || products.length === 0) && (!transfers || transfers.length === 0)) {
        html += `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">üì¶</div>
            <p style="color: var(--text-muted); font-size: 16px;">Nenhum produto no estoque</p>
          </div>
        `;
      }

      html += '</div>';
      document.getElementById('stockContent').innerHTML = html;
    }

    function hideStockModal() {
      document.getElementById('stockModal').style.display = 'none';
    }

    async function confirmDelete(id, name) {
      if (!confirm(`Tem certeza que deseja EXCLUIR o almoxarifado "${name}"?\\n\\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;

      try {
        const res = await fetch(`/warehouses/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.ok) {
          showAlert('Almoxarifado exclu√≠do com sucesso!', 'success');
          load();
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao excluir almoxarifado', 'error');
        }
      } catch (e) {
        showAlert('Erro ao excluir almoxarifado', 'error');
      }
    }

    document.getElementById('form').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('id').value;

      const payload = {
        name: document.getElementById('name').value,
        code: document.getElementById('code').value,
        type: document.getElementById('type').value,
        technicianId: document.getElementById('technicianId').value ? parseInt(document.getElementById('technicianId').value) : null
      };

      try {
        const res = await fetch(id ? `/warehouses/${id}` : '/warehouses', {
          method: id ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          showAlert(id ? 'Almoxarifado atualizado!' : 'Almoxarifado criado!', 'success');
          hideModal();
          load();
          loadTechnicians(); // Recarregar t√©cnicos para atualizar a lista
        } else {
          const error = await res.json();
          showAlert(error.message || 'Erro ao salvar', 'error');
        }
      } catch (e) {
        showAlert('Erro ao salvar', 'error');
      }
    };

    // Modal s√≥ fecha ao clicar no X
    // window.onclick = (e) => {
    //   if (e.target.id === 'modal') hideModal();
    //   if (e.target.id === 'stockModal') hideStockModal();
    // };

    // Toggle detalhes do item
    function toggleItemDetails(itemId) {
      const detailsDiv = document.getElementById(itemId);
      const btnText = document.getElementById(`${itemId}-btn-text`);

      if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        btnText.textContent = 'Ocultar Detalhes';
      } else {
        detailsDiv.style.display = 'none';
        btnText.textContent = 'Ver Detalhes';
      }
    }

    init();
  </script>
</body>
</html>
