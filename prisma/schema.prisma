generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICAÇÃO E PERMISSÕES
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String?
  roleId        Int
  role          Role     @relation(fields: [roleId], references: [id])
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Role {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  permissions RolePermission[]
  users       User[]
}

model Permission {
  id          Int             @id @default(autoincrement())
  code        String          @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])
  @@id([roleId, permissionId])
}

// ============================================
// TÉCNICOS
// ============================================

model Technician {
  id          Int                @id @default(autoincrement())
  name        String
  category    TechnicianCategory
  phone       String?
  email       String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  warehouse   Warehouse?
  transfers   Transfer[]
  usages      ProductUsage[]
  movements   StockMovement[]
}

enum TechnicianCategory {
  FIBRA
  RADIO
  INSTALACAO
  MANUTENCAO
  OUTROS
}

// ============================================
// ALMOXARIFADOS E LOCALIZAÇÕES
// ============================================

model Warehouse {
  id           Int           @id @default(autoincrement())
  name         String
  code         String        @unique
  type         WarehouseType @default(MAIN)
  technicianId Int?          @unique
  technician   Technician?   @relation(fields: [technicianId], references: [id])
  createdAt    DateTime      @default(now())
  locations    Location[]
  transfersFrom Transfer[]   @relation("TransferFrom")
  transfersTo   Transfer[]   @relation("TransferTo")
}

enum WarehouseType {
  MAIN
  TECHNICIAN
}

model Location {
  id          Int             @id @default(autoincrement())
  warehouseId Int
  warehouse   Warehouse       @relation(fields: [warehouseId], references: [id])
  code        String          @unique
  description String?
  movements   StockMovement[]
}

// ============================================
// PRODUTOS
// ============================================

model Product {
  id            Int               @id @default(autoincrement())
  sku           String            @unique
  name          String
  unit          String            @default("UN")
  barCode       String?
  minStock      Int               @default(0)
  trackSerial   Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  movements     StockMovement[]
  transferItems TransferItem[]
  usages        ProductUsage[]
  instances     ProductInstance[]
}

model ProductInstance {
  id                    Int       @id @default(autoincrement())
  productId             Int
  product               Product   @relation(fields: [productId], references: [id])
  serialNumber          String?
  macAddress            String?
  status                String    @default("AVAILABLE") // AVAILABLE, IN_USE, INUTILIZED
  locationId            Int?
  invoiceNumber         String?   // Número da NF de entrada
  invoiceDate           DateTime? // Data da NF de entrada
  invoiceFile           String?   // Caminho do arquivo PDF da NF
  receivedAt            DateTime? // Data de Recebimento do Produto
  supplier              String?   // Fornecedor
  entryDate             DateTime? // Data/hora do cadastro em estoque
  note                  String?   @db.Text // Observações da entrada
  inutilizedReason      String?   @db.Text // Motivo da inutilização
  inutilizedAt          DateTime? // Data/hora da inutilização
  awaitingReplacement   Boolean   @default(false) // Se está aguardando troca
  replacementRequested  Boolean   @default(false) // Se já foi solicitada a troca
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([productId])
  @@index([serialNumber])
  @@index([macAddress])
  @@index([status])
  @@index([awaitingReplacement])
}

// ============================================
// MOVIMENTAÇÕES DE ESTOQUE
// ============================================

model StockMovement {
  id            Int             @id @default(autoincrement())
  productId     Int
  product       Product         @relation(fields: [productId], references: [id])
  type          MovementType    @default(IN)
  quantity      Decimal         @db.Decimal(20,4)
  locationId    Int?
  location      Location?       @relation(fields: [locationId], references: [id])
  technicianId  Int?
  technician    Technician?     @relation(fields: [technicianId], references: [id])
  referenceType MovementRefType
  referenceId   Int
  invoiceNumber String?         // Número da Nota Fiscal (obrigatório para entradas)
  invoiceDate   DateTime?       // Data da Nota Fiscal
  invoiceFile   String?         // Caminho do arquivo PDF da NF
  receivedAt    DateTime?       // Data de Recebimento do Produto
  supplier      String?         // Fornecedor
  occurredAt    DateTime        @default(now())
  note          String?         @db.Text
}

enum MovementType {
  IN
  OUT
  ADJUST
  TRANSFER
}

enum MovementRefType {
  ENTRY
  TRANSFER
  USAGE
  ADJUSTMENT
}

// ============================================
// TRANSFERÊNCIAS (Almoxarifado Principal -> Técnico)
// ============================================

model Transfer {
  id              Int              @id @default(autoincrement())
  number          String           @unique
  fromWarehouseId Int
  fromWarehouse   Warehouse        @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouseId   Int
  toWarehouse     Warehouse        @relation("TransferTo", fields: [toWarehouseId], references: [id])
  technicianId    Int
  technician      Technician       @relation(fields: [technicianId], references: [id])
  status          TransferStatus   @default(PENDING)
  transferredAt   DateTime?        // Data/hora que saiu do estoque
  receivedAt      DateTime?        // Data/hora que voltou ao estoque
  signatureFile   String?          // Arquivo da assinatura (PDF ou imagem)
  signatureType   String?          // 'digital' ou 'upload'
  reportFile      String?          // PDF do relatório gerado
  createdBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  items           TransferItem[]
  note            String?          @db.Text
}

model TransferItem {
  id                Int               @id @default(autoincrement())
  transferId        Int
  transfer          Transfer          @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId         Int
  product           Product           @relation(fields: [productId], references: [id])
  productInstanceId Int?              // ID da instância específica (SN/MAC)
  serialNumber      String?           // Serial Number do produto
  macAddress        String?           // MAC Address do produto
  invoiceNumber     String?           // Número da NF do produto
  quantity          Decimal           @db.Decimal(20,4)
  status            TransferItemStatus @default(PENDING)
  usedAt            DateTime?         // Quando foi marcado como usado
  returnedAt        DateTime?         // Quando foi devolvido
  ixcClientCode     String?           // Código do cliente IXC onde foi usado
  usageNote         String?           @db.Text // Observação de uso
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

enum TransferStatus {
  PENDING           // Aguardando saída
  IN_HANDS          // Em mãos com técnico
  PARTIALLY_USED    // Alguns itens usados
  USED              // Todos itens usados
  PARTIALLY_RETURNED // Alguns itens devolvidos
  RETURNED          // Todos itens devolvidos
  CANCELED          // Cancelado
}

enum TransferItemStatus {
  PENDING   // Pendente
  IN_HANDS  // Em mãos com técnico
  USED      // Usado/Instalado
  RETURNED  // Devolvido
}

// ============================================
// USO DE PRODUTOS PELOS TÉCNICOS
// ============================================

model ProductUsage {
  id           Int        @id @default(autoincrement())
  technicianId Int
  technician   Technician @relation(fields: [technicianId], references: [id])
  productId    Int
  product      Product    @relation(fields: [productId], references: [id])
  quantity     Decimal    @db.Decimal(20,4)
  usedAt       DateTime   @default(now())
  note         String?    @db.Text
  serviceOrder String?
  clientName   String?
}